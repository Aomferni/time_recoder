{% extends "base.html" %}

{% block content %}
<h1>时间追踪器</h1>

<div class="user-section">
    <div class="user-input-section">
        <label for="usernameInput">用户名:</label>
        <input type="text" id="usernameInput" placeholder="请输入用户名">
        <button class="control-btn" id="setUsernameBtn">设置</button>
    </div>
    
    <div class="user-action-section">
        <button class="control-btn" id="toggleDetailModeBtn" onclick="TimeRecorderUI.toggleDetailMode()">切换到简化版详情</button>
        
        <!-- 导入记录按钮 -->
        <div class="import-section">
            <input type="file" id="recordFileInput" accept=".json" class="file-input" style="display: none;">
            <button class="control-btn import-btn" id="importRecordBtn">导入记录</button>
            <div id="importStatus" class="import-status"></div>
        </div>
    </div>
    
    <!-- 将导航链接移到右上角 -->
    <div class="top-navigation">
        <a href="/records" class="nav-link">查看历史记录</a>
        <a href="/mood-wall" class="nav-link">情绪与活动墙</a>
        <a href="/project-description" class="nav-link">项目说明</a>
        <a href="/manage-categories" class="nav-link">管理类别</a>
    </div>
</div>

<div class="main-layout">
    <div class="section">
        <h2>选择活动</h2>
        
        <!-- 活动按钮将通过JavaScript动态生成 -->
        
    </div>
    
    <div class="section">
        <div class="current-activity" id="currentActivity" contenteditable="false">请选择活动</div>
        
        <!-- 突出显示的计时器区域 -->
        <div class="focus-timer-section">
            <div class="focus-label">当前持续专注时长</div>
            <div class="timer-display" id="timerDisplay">00:00:00</div>
        </div>
        
        <div class="control-buttons">
            <button class="control-btn toggle-btn" id="toggleBtn">开始</button>
        </div>
        <h2>今日记录（<span id="currentDate"></span>）</h2>
        <table class="records-table">
            <thead>
                <tr>
                    <th>活动</th>
                    <th>开始时间</th>
                    <th>计时时长</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="recordsBody">
            </tbody>
        </table>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>今日总计</h3>
                <p id="totalTime">0小时0分</p>
            </div>
            <div class="stat-card">
                <h3>活动次数</h3>
                <p id="activityCount">0次</p>
            </div>
        </div>
    </div>
</div>

<!-- 活动详情浮窗 -->
<div id="recordDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="TimeRecorderUI.closeRecordDetailModal()">&times;</span>
        <h2>活动详情</h2>
        <div id="recordDetailContent"></div>
    </div>
</div>

<script>
// 导入记录功能
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('importRecordBtn');
    const fileInput = document.getElementById('recordFileInput');
    const importStatus = document.getElementById('importStatus');
    
    if (importBtn && fileInput) {
        // 点击导入按钮时触发文件选择
        importBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // 文件选择后处理导入
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files.length > 0) {
                importRecordFile(fileInput.files[0]);
            }
        });
    }
    
    // 导入记录文件函数
    function importRecordFile(file) {
        if (!file) {
            showImportStatus('请选择要导入的文件', 'error');
            return;
        }
        
        const username = window.TimeRecorderConfig ? window.TimeRecorderConfig.currentUsername : null;
        if (!username || username === 'default') {
            showImportStatus('请先设置用户名', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', username);
        
        showImportStatus('正在导入...', 'info');
        
        fetch('/api/import-records', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showImportStatus(`导入成功！共导入 ${data.imported_count} 条记录`, 'success');
                // 清空文件选择
                fileInput.value = '';
                // 重新加载记录
                if (window.TimeRecorderUI && window.TimeRecorderUI.loadRecords) {
                    window.TimeRecorderUI.loadRecords();
                }
            } else {
                showImportStatus(`导入失败: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('导入记录失败:', error);
            showImportStatus('导入失败，请查看控制台了解详情', 'error');
        });
    }
    
    // 显示导入状态
    function showImportStatus(message, type) {
        if (!importStatus) return;
        
        importStatus.textContent = message;
        importStatus.className = 'import-status ' + type;
        
        // 3秒后自动清除状态信息
        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                importStatus.textContent = '';
                importStatus.className = 'import-status';
            }, 3000);
        }
    }
});
</script>
{% endblock %}