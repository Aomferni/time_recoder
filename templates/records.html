{% extends "base.html" %}

{% block title %}历史记录 - 时间追踪器{% endblock %}

{% block content %}
<h1>历史记录（<span id="currentUsernameDisplay">default</span>）</h1>

<div class="records-header">
    <div class="navigation">
        <a href="/" class="nav-link">返回首页</a>
        <a href="/mood-wall" class="nav-link">情绪与活动墙</a>
        <a href="/project-description" class="nav-link">项目说明</a>
    </div>
</div>

<div class="records-controls">
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="dateFrom">开始日期:</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label for="dateTo">结束日期:</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label for="activityFilter">活动类型:</label>
                <select id="activityFilter">
                    <option value="">全部活动</option>
                    <!-- 活动选项将通过JavaScript动态填充 -->
                </select>
            </div>
            <div class="filter-group">
                <label for="emotionFilter">情绪:</label>
                <select id="emotionFilter">
                    <option value="">全部情绪</option>
                    <option value="开心">开心</option>
                    <option value="专注">专注</option>
                    <option value="疲惫">疲惫</option>
                    <option value="焦虑">焦虑</option>
                    <option value="兴奋">兴奋</option>
                    <option value="平静">平静</option>
                    <option value="沮丧">沮丧</option>
                    <option value="满足">满足</option>
                    <option value="无聊">无聊</option>
                </select>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label for="searchInput">搜索:</label>
                <input type="text" id="searchInput" placeholder="活动名称或备注信息">
            </div>
            <div class="filter-actions">
                <button class="control-btn search-btn" onclick="applyFilters()">搜索</button>
                <button class="control-btn reset-btn" onclick="resetFilters()">重置</button>
            </div>
        </div>
    </div>
</div>

<!-- 活动详情浮窗 -->
<div id="recordDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="TimeRecorderUI.closeRecordDetailModal()">&times;</span>
        <h2>活动详情</h2>
        <div id="recordDetailContent"></div>
    </div>
</div>

<div class="records-table-container">
    <table class="records-table">
        <thead>
            <tr>
                <th>日期</th>
                <th>活动</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>计时时长</th>
                <th>时间跨度</th>
                <th>备注信息</th>
                <th>记录情绪</th>
                <th>暂停次数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recordsBody">
        </tbody>
    </table>
</div>

<div class="pagination" id="pagination">
    <!-- 分页控件将通过JavaScript动态生成 -->
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let allActivities = new Set();
    let currentDetailRecordId = null; // 用于跟踪当前详情浮窗的记录ID
    let currentUsername = 'default'; // 当前用户名

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化用户名
        const savedUsername = localStorage.getItem('timeRecorderUsername');
        if (savedUsername) {
            currentUsername = savedUsername;
            // 更新标题中的用户名显示
            document.getElementById('currentUsernameDisplay').textContent = savedUsername;
        } else {
            // 如果没有找到保存的用户名，尝试从URL参数获取
            const urlParams = new URLSearchParams(window.location.search);
            const urlUsername = urlParams.get('username');
            if (urlUsername) {
                currentUsername = urlUsername;
                document.getElementById('currentUsernameDisplay').textContent = urlUsername;
                // 同时保存到localStorage
                localStorage.setItem('timeRecorderUsername', urlUsername);
            }
        }
        
        // 确保标题显示正确的用户名
        document.getElementById('currentUsernameDisplay').textContent = currentUsername;
        
        loadRecords();
        
        // 检查URL参数中是否有recordId，如果有则自动打开记录详情
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('recordId');
        if (recordId) {
            // 延迟一段时间确保页面加载完成后再打开详情
            setTimeout(() => {
                showRecordDetail(recordId);
            }, 500);
        }
        
        // 点击表格外区域关闭浮窗
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('recordDetailModal');
            if (event.target === modal) {
                TimeRecorderUI.closeRecordDetailModal();
            }
        });
        
        // 添加键盘事件监听器，支持ESC键关闭模态框
        document.addEventListener('keydown', handleKeyDown);
    });

    // 处理键盘事件
    function handleKeyDown(event) {
        // ESC键关闭模态框
        if (event.key === 'Escape') {
            TimeRecorderUI.closeRecordDetailModal();
        }
    }

    // 加载记录
    function loadRecords(page = 1) {
        currentPage = page;
        
        // 获取筛选参数
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const activity = document.getElementById('activityFilter').value;
        const emotion = document.getElementById('emotionFilter').value;
        const search = document.getElementById('searchInput').value;
        
        // 构建查询参数
        const params = new URLSearchParams();
        params.append('page', page);
        params.append('per_page', 20);
        params.append('username', currentUsername);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (activity) params.append('activity', activity);
        if (emotion) params.append('emotion', emotion);
        if (search) params.append('search', search);
        
        fetch(`/api/all-records?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateRecordsTable(data.records);
                    updatePagination(data.pagination);
                    updateActivityFilter(data.records);
                }
            })
            .catch(error => {
                console.error('加载记录失败:', error);
            });
    }

    // 更新记录表格
    function updateRecordsTable(records) {
        const tbody = document.getElementById('recordsBody');
        tbody.innerHTML = '';
        
        records.forEach((record, index) => {
            const activityClass = TimeRecorderFrontendUtils.getActivityClass(record.activity, record.activityCategory);
            
            // 处理情绪显示，添加颜色
            const emotionDisplay = record.emotion ? 
                record.emotion.split(', ').map(e => 
                    `<span class="emotion-tag" style="background-color: ${TimeRecorderFrontendUtils.getEmotionColor(e)};">${e}</span>`
                ).join(' ') : '';
            
            // 根据规范，duration记录所有segments累计的时间
            const totalDuration = record.duration || 0;
            
            const row = tbody.insertRow();
            // 删除编辑按钮，只保留继续和删除按钮
            row.innerHTML = `
                <td>${record.date || (record.startTime ? record.startTime.substring(0, 10).replace(/-/g, '/') : '')}</td>
                <td><span class="activity-label ${activityClass}" onclick="showRecordDetail('${record.id}')">${record.activity}</span></td>
                <td>${TimeRecorderFrontendUtils.formatTime(new Date(record.startTime))}</td>
                <td>${TimeRecorderFrontendUtils.formatTime(new Date(record.endTime))}</td>
                <td>${TimeRecorderFrontendUtils.formatDuration(totalDuration)}</td>
                <td>${TimeRecorderFrontendUtils.formatDuration(record.timeSpan)}</td>
                <td>${record.remark || ''}</td>
                <td>${emotionDisplay}</td>
                <td>${record.pauseCount || 0}</td>
                <td>
                    <button class="continue-btn" onclick="continueActivity('${record.id}')">继续</button>
                    <button class="delete-btn" onclick="deleteRecord('${record.id}')">删除</button>
                </td>
            `;
        });
    }

    // 继续选中的活动
    function continueActivity(recordId) {
        // 通过API获取指定记录的详细信息
        fetch(`/api/records/${recordId}?username=${encodeURIComponent(currentUsername)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const record = data.record;
                    
                    // 重定向到首页并传递活动信息
                    // 使用localStorage传递数据
                    localStorage.setItem('continueActivity', JSON.stringify({
                        activity: record.activity,
                        activityCategory: record.activityCategory,
                        remark: record.remark || '',
                        emotion: record.emotion || '',
                        recordId: record.id, // 传递记录ID
                        autoStart: true // 标记需要自动开始计时
                    }));
                    
                    // 跳转到首页
                    window.location.href = '/';
                } else {
                    console.error('获取记录详情失败:', data.error);
                }
            })
            .catch(error => {
                console.error('获取记录详情失败:', error);
            });
    }

    // 显示记录详情浮窗
    function showRecordDetail(recordId) {
        fetch(`/api/records/${recordId}?username=${encodeURIComponent(currentUsername)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const record = data.record;
                    currentDetailRecordId = recordId;
                    const activityClass = TimeRecorderFrontendUtils.getActivityCategoryClass(record.activityCategory || getRecordCategory(record.activity));
                    
                    // 处理段落信息显示
                    let segmentsDisplay = '';
                    // 根据规范，duration记录所有segments累计的时间
                    // 重新计算段落总时间以确保准确性
                    let totalDuration = 0;
                    if (record.segments && Array.isArray(record.segments)) {
                        // 使用工具类计算所有段落的总时间
                        totalDuration = TimeRecorderFrontendUtils.calculateSegmentsTotalTime(record.segments);
                    }
                    // 如果计算结果为0，使用record.duration作为后备值
                    if (totalDuration === 0) {
                        totalDuration = (record && record.duration) || 0;
                    }
                    if (record.segments && record.segments.length > 0) {
                        // 计算每个段落的持续时间
                        const segmentDetails = record.segments.map((segment, index) => {
                            // 数据存储的是UTC时间，需要转换为北京时间显示
                            const start = new Date(segment.start);
                            const end = new Date(segment.end);
                            const duration = end - start;
                            return {
                                index,
                                start,
                                end,
                                duration
                            };
                        });
                        
                        // 生成段落显示内容
                        segmentsDisplay = segmentDetails.map(segment => {
                            return `
                                <div class="segment-row" data-segment-index="${segment.index}">
                                    <span>段落 ${segment.index + 1}:</span>
                                    <input type="datetime-local" class="segment-start" value="${TimeRecorderFrontendUtils.formatDateTimeForInput(segment.start)}">
                                    <span> - </span>
                                    <input type="datetime-local" class="segment-end" value="${TimeRecorderFrontendUtils.formatDateTimeForInput(segment.end)}">
                                    <span>(${TimeRecorderFrontendUtils.formatDuration(segment.duration)})</span>
                                    <button type="button" class="delete-btn small" onclick="deleteSegment('${recordId}', ${segment.index})">删除</button>
                                </div>
                            `;
                        }).join('');
                        
                        // 添加段落统计信息
                        const totalSegmentDuration = segmentDetails.reduce((total, segment) => total + segment.duration, 0);
                        segmentsDisplay += `
                            <div class="segment-summary">
                                <p>段落数量: ${segmentDetails.length}</p>
                                <p>段落总时长: ${TimeRecorderFrontendUtils.formatDuration(totalSegmentDuration)}</p>
                            </div>
                        `;
                    } else {
                        segmentsDisplay = '<div class="segment-row">暂无段落记录</div>';
                    }
                    
                    // 构建详情内容
                    const detailContent = `
                        <form id="recordDetailForm" class="detail-form">
                            <div class="detail-section">
                                <h3>基本信息</h3>
                                <label>活动:</label>
                                <input type="text" value="${record.activity}" id="detail-activity" class="${activityClass}">
                                
                                <label>活动类别:</label>
                                <select id="detail-activity-category" class="${activityClass}">
                                    <option value="工作输出" ${record.activityCategory === '工作输出' ? 'selected' : ''}>工作输出</option>
                                    <option value="大脑充电" ${record.activityCategory === '大脑充电' ? 'selected' : ''}>大脑充电</option>
                                    <option value="身体充电" ${record.activityCategory === '身体充电' ? 'selected' : ''}>身体充电</option>
                                    <option value="修养生息" ${record.activityCategory === '修养生息' ? 'selected' : ''}>修养生息</option>
                                    <option value="暂停一下" ${record.activityCategory === '暂停一下' ? 'selected' : ''}>暂停一下</option>
                                    <option value="输出创作" ${record.activityCategory === '输出创作' ? 'selected' : ''}>输出创作</option>
                                    <option value="纯属娱乐" ${record.activityCategory === '纯属娱乐' ? 'selected' : ''}>纯属娱乐</option>
                                </select>
                                
                                <label>记录ID:</label>
                                <input type="text" value="${record.id}" id="detail-id" readonly>
                                
                                <label>记录日期:</label>
                                <input type="text" value="${record.date || (record.startTime ? record.startTime.substring(0, 10).replace(/-/g, '/') : '')}" id="detail-date" readonly>
                            </div>
                            
                            <div class="detail-section">
                                <h3>时间信息</h3>
                                <label>开始时间:</label>
                                <input type="datetime-local" value="${TimeRecorderFrontendUtils.formatDateTimeForInput(new Date(record.startTime))}" id="detail-start-time">
                                
                                <label>结束时间:</label>
                                <input type="datetime-local" value="${TimeRecorderFrontendUtils.formatDateTimeForInput(new Date(record.endTime))}" id="detail-end-time">
                                
                                <label>时间跨度:</label>
                                <input type="text" value="${TimeRecorderFrontendUtils.formatDuration(record.timeSpan)}" id="detail-time-span" readonly>
                                
                                <label>计时时长:</label>
                                <input type="text" value="${TimeRecorderFrontendUtils.formatDuration(totalDuration)}" id="detail-duration" readonly>
                            </div>
                            
                            <div class="detail-section">
                                <h3>其他信息</h3>
                                <label>暂停次数:</label>
                                <input type="number" value="${record.pauseCount || 0}" id="detail-pause-count" min="0">
                                
                                <label>段落记录:</label>
                                <div class="segments-display">
                                    ${segmentsDisplay}
                                    <button type="button" class="control-btn" onclick="addSegment('${recordId}')">添加段落</button>
                                </div>
                            </div>
                            
                            <div class="detail-section highlight-field" id="detail-remark-section">
                                <h3>记录收获</h3>
                                <label>备注信息:</label>
                                <textarea id="detail-remark">${record.remark || ''}</textarea>
                            </div>
                            
                            <div class="detail-section">
                                <h3>记录情绪</h3>
                                <div class="emotion-checkboxes" id="detail-emotion">
                                    ${getEmotionOptions().map(emotion => `
                                        <div class="emotion-checkbox">
                                            <input type="checkbox" id="emotion-${emotion}" value="${emotion}" 
                                                ${record.emotion && record.emotion.includes(emotion) ? 'checked' : ''}>
                                            <label for="emotion-${emotion}" style="color: ${TimeRecorderFrontendUtils.getEmotionColor(emotion)};">${emotion}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="detail-actions">
                                <button type="button" class="save-btn" onclick="saveRecordDetail('${record.id}')">保存</button>
                                <button type="button" class="cancel-btn" onclick="TimeRecorderUI.closeRecordDetailModal()">关闭</button>
                            </div>
                        </form>
                    `;
                    
                    document.getElementById('recordDetailContent').innerHTML = detailContent;
                    document.getElementById('recordDetailModal').style.display = 'block';
                    
                    // 绑定开始时间和结束时间的更改事件
                    document.getElementById('detail-start-time').addEventListener('change', function() {
                        updateTimeSpan(recordId);
                    });
                    
                    document.getElementById('detail-end-time').addEventListener('change', function() {
                        updateTimeSpan(recordId);
                    });
                    
                    // 绑定活动类别更改事件，更新活动输入框的样式
                    document.getElementById('detail-activity-category').addEventListener('change', function() {
                        const selectedCategory = this.value;
                        const activityClass = getActivityCategoryClass(selectedCategory);
                        const activityInput = document.getElementById('detail-activity');
                        // 移除所有可能的类别类
                        Object.values(getActivityCategoryClassMap()).forEach(cls => {
                            activityInput.classList.remove(cls);
                        });
                        // 添加新的类别类
                        activityInput.classList.add(activityClass);
                    });
                } else {
                    console.error('加载记录详情失败:', data.error);
                }
            })
            .catch(error => {
                console.error('加载记录详情失败:', error);
            });
    }

    // 关闭记录详情浮窗
    /*
    function closeRecordDetailModal() {
        document.getElementById('recordDetailModal').style.display = 'none';
        currentDetailRecordId = null;
    }
    */

    // 更新时间跨度
    function updateTimeSpan(recordId) {
        const startTimeStr = document.getElementById('detail-start-time').value;
        const endTimeStr = document.getElementById('detail-end-time').value;
        
        if (startTimeStr && endTimeStr) {
            // 输入框中的时间已经是北京时间格式
            const startDate = new Date(startTimeStr);
            const endDate = new Date(endTimeStr);
            const timeSpan = endDate - startDate;
            
            document.getElementById('detail-time-span').value = TimeRecorderFrontendUtils.formatDuration(timeSpan);
        }
    }

    // 添加段落
    function addSegment(recordId) {
        const segmentsContainer = document.querySelector('.segments-display');
        const segmentCount = document.querySelectorAll('.segment-row[data-segment-index]').length;
        
        // 获取当前时间作为默认时间（使用北京时间）
        const now = new Date();
        const defaultTime = TimeRecorderFrontendUtils.formatDateTimeForInput(now);
        
        const newSegment = `
            <div class="segment-row" data-segment-index="${segmentCount}">
                <span>段落 ${segmentCount + 1}:</span>
                <input type="datetime-local" class="segment-start" value="${defaultTime}">
                <span> - </span>
                <input type="datetime-local" class="segment-end" value="${defaultTime}">
                <span>(0秒)</span>
                <button type="button" class="delete-btn small" onclick="deleteSegment('${recordId}', ${segmentCount})">删除</button>
            </div>
        `;
        
        // 在添加按钮前插入新段落
        const addButton = segmentsContainer.querySelector('button');
        segmentsContainer.insertBefore(document.createRange().createContextualFragment(newSegment), addButton);
    }

    // 删除段落
    function deleteSegment(recordId, segmentIndex) {
        const segmentRow = document.querySelector(`.segment-row[data-segment-index="${segmentIndex}"]`);
        if (segmentRow) {
            segmentRow.remove();
            // 重新编号剩余的段落
            renumberSegments();
        }
    }

    // 重新编号段落
    function renumberSegments() {
        const segmentRows = document.querySelectorAll('.segment-row[data-segment-index]');
        segmentRows.forEach((row, index) => {
            row.setAttribute('data-segment-index', index);
            row.querySelector('span').textContent = `段落 ${index + 1}:`;
            const deleteButton = row.querySelector('.delete-btn');
            if (deleteButton) {
                // 更新删除按钮的onclick属性
                deleteButton.setAttribute('onclick', deleteButton.getAttribute('onclick').replace(/\d+$/, index));
            }
        });
    }

    // 保存记录详情
    function saveRecordDetail(recordId) {
        const activity = document.getElementById('detail-activity').value;
        const activityCategory = document.getElementById('detail-activity-category').value;
        const startTimeStr = document.getElementById('detail-start-time').value;
        const endTimeStr = document.getElementById('detail-end-time').value;
        const remark = document.getElementById('detail-remark').value;
        
        // 获取选中的情绪
        const emotionCheckboxes = document.querySelectorAll('#detail-emotion input[type="checkbox"]:checked');
        const emotions = Array.from(emotionCheckboxes).map(cb => cb.value).join(', ');
        
        const pauseCount = document.getElementById('detail-pause-count').value;
        
        // 获取段落信息
        const segmentRows = document.querySelectorAll('.segment-row[data-segment-index]');
        const segments = [];
        segmentRows.forEach(row => {
            const startIndex = row.querySelector('.segment-start').value;
            const endIndex = row.querySelector('.segment-end').value;
            
            if (startIndex && endIndex) {
                try {
                    // 输入框中的时间已经是北京时间格式，需要转换为UTC时间存储
                    const beijingStart = new Date(startIndex);
                    const beijingEnd = new Date(endIndex);
                    // 转换为UTC时间存储（减去8小时偏移）
                    const utcStart = new Date(beijingStart.getTime() - 8 * 60 * 60 * 1000);
                    const utcEnd = new Date(beijingEnd.getTime() - 8 * 60 * 60 * 1000);
                    
                    if (!isNaN(utcStart.getTime()) && !isNaN(utcEnd.getTime())) {
                        segments.push({
                            start: utcStart.toISOString(),
                            end: utcEnd.toISOString()
                        });
                    }
                } catch (e) {
                    console.error('处理段落时间时出错:', e);
                }
            }
        });
        
        // 构造更新数据
        const updateData = {
            activity: activity,
            activityCategory: activityCategory,
            remark: remark,
            emotion: emotions,
            pauseCount: parseInt(pauseCount) || 0,
            segments: segments
        };
        
        // 更新时间
        if (startTimeStr && endTimeStr) {
            try {
                // 输入框中的时间已经是北京时间格式，需要转换为UTC时间存储
                const beijingStartDate = new Date(startTimeStr);
                const beijingEndDate = new Date(endTimeStr);
                // 转换为UTC时间存储（减去8小时偏移）
                const utcStartDate = new Date(beijingStartDate.getTime() - 8 * 60 * 60 * 1000);
                const utcEndDate = new Date(beijingEndDate.getTime() - 8 * 60 * 60 * 1000);
                
                if (!isNaN(utcStartDate.getTime()) && !isNaN(utcEndDate.getTime())) {
                    updateData.startTime = utcStartDate.toISOString();
                    updateData.endTime = utcEndDate.toISOString();
                    
                    // 重新计算时间跨度
                    const timeSpan = utcEndDate - utcStartDate;
                    updateData.timeSpan = timeSpan;
                }
            } catch (e) {
                console.error('处理时间时出错:', e);
            }
        }
        
        // 发送到后端更新
        fetch(`/api/records/${recordId}?username=${encodeURIComponent(currentUsername)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                TimeRecorderUI.closeRecordDetailModal();
                loadRecords(currentPage);
            } else {
                alert('更新记录失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('更新记录失败:', error);
            alert('更新记录失败，请查看控制台了解详情');
        });
    }

    // 更新分页控件
    function updatePagination(pagination) {
        totalPages = pagination.pages;
        const paginationEl = document.getElementById('pagination');
        
        let paginationHTML = '';
        
        // 上一页按钮
        if (currentPage > 1) {
            paginationHTML += `<button onclick="loadRecords(${currentPage - 1})">上一页</button>`;
        }
        
        // 页码按钮
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="active">${i}</button>`;
            } else {
                paginationHTML += `<button onclick="loadRecords(${i})">${i}</button>`;
            }
        }
        
        // 下一页按钮
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="loadRecords(${currentPage + 1})">下一页</button>`;
        }
        
        paginationEl.innerHTML = paginationHTML;
    }

    // 更新活动筛选下拉框
    function updateActivityFilter(records) {
        records.forEach(record => {
            allActivities.add(record.activity);
        });
        
        const activityFilter = document.getElementById('activityFilter');
        const currentSelection = activityFilter.value;
        
        // 清空现有选项（保留第一个"全部活动"选项）
        while (activityFilter.options.length > 1) {
            activityFilter.remove(1);
        }
        
        // 添加所有活动选项
        allActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity;
            option.text = activity;
            activityFilter.add(option);
        });
        
        // 恢复之前的选中项
        activityFilter.value = currentSelection;
    }

    // 应用筛选条件
    function applyFilters() {
        loadRecords(1);
    }

    // 重置筛选条件
    function resetFilters() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('activityFilter').value = '';
        document.getElementById('emotionFilter').value = '';
        document.getElementById('searchInput').value = '';
        loadRecords(1);
    }

    // 编辑记录
    function editRecord(recordId) {
        showRecordDetail(recordId);
    }

    // 删除记录
    function deleteRecord(recordId) {
        if (!confirm('确定要删除这条记录吗？')) {
            return;
        }
        
        fetch(`/api/records/${recordId}?username=${encodeURIComponent(currentUsername)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadRecords(currentPage);
            } else {
                alert('删除记录失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('删除记录失败:', error);
            alert('删除记录失败，请查看控制台了解详情');
        });
    }

    

    // 解析时间字符串为毫秒数
    function parseDurationString(durationStr) {
        // 支持格式：1小时30分钟、90分钟、1.5小时等
        const hourMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*小时/);
        const minuteMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*分钟/);
        const secondMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*秒/);
        
        let totalMs = 0;
        
        if (hourMatch) {
            totalMs += parseFloat(hourMatch[1]) * 3600000;
        }
        
        if (minuteMatch) {
            totalMs += parseFloat(minuteMatch[1]) * 60000;
        }
        
        if (secondMatch) {
            totalMs += parseFloat(secondMatch[1]) * 1000;
        }
        
        // 如果没有匹配到任何单位，尝试直接解析数字作为分钟
        if (totalMs === 0 && !isNaN(parseFloat(durationStr))) {
            totalMs = parseFloat(durationStr) * 60000;
        }
        
        return totalMs > 0 ? Math.round(totalMs) : null;
    }

    // 获取情绪选项
    function getEmotionOptions() {
        return ['开心', '专注', '疲惫', '焦虑', '兴奋', '平静', '沮丧', '满足', '无聊'];
    }

    /**
     * 时间记录器前端工具类
     */
    const TimeRecorderFrontendUtils = {
        /**
         * 获取情绪颜色
         */
        getEmotionColor: function(emotion) {
            const emotionColorMap = {
                '开心': '#4CAF50',    // 绿色
                '专注': '#2196F3',    // 蓝色
                '疲惫': '#9E9E9E',    // 灰色
                '焦虑': '#FF9800',    // 橙色
                '兴奋': '#E91E63',    // 粉色
                '平静': '#00BCD4',    // 青色
                '沮丧': '#F44336',    // 红色
                '满足': '#8BC34A',    // 黄绿色
                '无聊': '#795548'     // 棕色
            };
            return emotionColorMap[emotion] || '#607D8B'; // 默认灰色
        },
        
        /**
         * 活动类别到CSS类的映射
         */
        getActivityCategoryClassMap: function() {
            return {
                // 工作输出类 - 蓝色系
                '工作输出': 'btn-work-output',
                
                // 大脑充电类 - 绿色系
                '大脑充电': 'btn-brain-charge',
                
                // 修养生息类 - 紫色系
                '修养生息': 'btn-rest',
                
                // 身体改善类 - 橙色系
                '身体改善': 'btn-body',
                
                // 沟通交流类 - 青色系
                '沟通交流': 'btn-communication',
                
                // 探索新方法类 - 深紫系
                '探索新方法': 'btn-explore',
                
                // 纯属娱乐类 - 粉色系
                '纯属娱乐': 'btn-entertainment',
                
                // 保持学习类 - 蓝绿系
                '保持学习': 'btn-learning',
                
                // 生活计划类 - 黄绿系
                '生活计划': 'btn-planning',
                
                // 规律作息类 - 灰色系
                '规律作息': 'btn-routine'
            };
        },
        
        /**
         * 获取活动类别对应的CSS类
         */
        getActivityCategoryClass: function(activityCategory) {
            const categoryClassMap = this.getActivityCategoryClassMap();
            return categoryClassMap[activityCategory] || 'btn-work-output'; // 默认使用工作输出类颜色
        },
        
        /**
         * 获取活动对应的CSS类（基于活动类别）
         */
        getActivityClass: function(activity, activityCategory) {
            if (activityCategory) {
                return this.getActivityCategoryClass(activityCategory);
            }
            // 如果没有活动类别，使用原来的映射
            const activityClassMap = {
                // 工作输出类 - 蓝色系
                '进入工作状态': 'btn-work-output',
                '梳理方案': 'btn-work-output',
                '执行工作': 'btn-work-output',
                '开会': 'btn-work-output',
                '复盘': 'btn-work-output',
                '探索新方法': 'btn-work-output',
                
                // 大脑充电类 - 绿色系
                '和智者对话': 'btn-brain-charge',
                '做调研': 'btn-learning',
                
                // 修养生息类 - 紫色系
                '睡觉仪式': 'btn-rest',
                '处理日常': 'btn-rest',
                
                // 身体改善类 - 橙色系
                '健身': 'btn-body',
                '创作/写作': 'btn-body',
                
                // 沟通交流类 - 青色系
                '交流心得': 'btn-communication',
                '散步': 'btn-communication',
                '记录|反思|计划': 'btn-communication',
                
                // 玩玩具属于纯属娱乐类 - 粉色系
                '玩玩具': 'btn-entertainment'
            };
            
            return activityClassMap[activity] || 'btn-work-output'; // 默认使用工作输出类颜色
        },
        
        /**
         * 计算段落总时间
         */
        calculateSegmentsTotalTime: function(segments) {
            let total = 0;
            if (segments && Array.isArray(segments)) {
                segments.forEach(segment => {
                    if (segment.start && segment.end) {
                        // 使用北京时间
                        const start = new Date(segment.start).getTime();
                        const end = new Date(segment.end).getTime();
                        total += (end - start);
                    }
                });
            }
            return total;
        },
        
        /**
         * 格式化时间
         */
        formatTime: function(date) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        },
        
        /**
         * 格式化日期时间用于输入框
         */
        formatDateTimeForInput: function(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        },
        
        /**
         * 格式化时长
         */
        formatDuration: function(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}小时${minutes}分钟`;
            } else {
                return `${minutes}分钟${seconds}秒`;
            }
        }
    };
</script>
{% endblock %}