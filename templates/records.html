{% extends "base.html" %}

{% block title %}历史记录 - 时间追踪器{% endblock %}

{% block content %}
<h1>历史记录</h1>

<div class="records-header">
    <div class="navigation">
        <a href="/" class="nav-link">返回首页</a>
        <a href="/mood-wall" class="nav-link">情绪与活动墙</a>
        <a href="/project-description" class="nav-link">项目说明</a>
    </div>
</div>

<div class="records-controls">
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="dateFrom">开始日期:</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label for="dateTo">结束日期:</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label for="activityFilter">活动类型:</label>
                <select id="activityFilter">
                    <option value="">全部活动</option>
                    <!-- 活动选项将通过JavaScript动态填充 -->
                </select>
            </div>
            <div class="filter-group">
                <label for="emotionFilter">情绪:</label>
                <select id="emotionFilter">
                    <option value="">全部情绪</option>
                    <option value="开心">开心</option>
                    <option value="专注">专注</option>
                    <option value="疲惫">疲惫</option>
                    <option value="焦虑">焦虑</option>
                    <option value="兴奋">兴奋</option>
                    <option value="平静">平静</option>
                    <option value="沮丧">沮丧</option>
                    <option value="满足">满足</option>
                    <option value="无聊">无聊</option>
                </select>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label for="searchInput">搜索:</label>
                <input type="text" id="searchInput" placeholder="活动名称或备注信息">
            </div>
            <div class="filter-actions">
                <button class="control-btn search-btn" onclick="applyFilters()">搜索</button>
                <button class="control-btn reset-btn" onclick="resetFilters()">重置</button>
                <button class="control-btn export-btn" onclick="exportRecords()">导出记录</button>
                <!-- 导入记录按钮 -->
                <input type="file" id="recordFileInput" accept=".json" class="file-input" style="display: none;">
                <button class="control-btn import-btn" id="importRecordBtn">导入记录</button>
                <div id="importStatus" class="import-status"></div>
            </div>
        </div>
    </div>
</div>

<!-- 活动详情浮窗 -->
<div id="recordDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="TimeRecorderRecordDetail.closeRecordDetailModal()">&times;</span>
        <h2>活动详情</h2>
        <div id="recordDetailContent"></div>
    </div>
</div>

<div class="records-table-container">
    <table class="records-table">
        <thead>
            <tr>
                <th>日期</th>
                <th>活动</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>计时时长</th>
                <th>时间跨度</th>
                <th>备注信息</th>
                <th>记录情绪</th>
                <th>暂停次数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recordsBody">
        </tbody>
    </table>
</div>

<div class="pagination" id="pagination">
    <!-- 分页控件将通过JavaScript动态生成 -->
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let allActivities = new Set();
    let currentDetailRecordId = null; // 用于跟踪当前详情浮窗的记录ID

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadRecords();
        
        // 检查URL参数中是否有recordId，如果有则自动打开记录详情
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('recordId');
        if (recordId) {
            // 延迟一段时间确保页面加载完成后再打开详情
            setTimeout(() => {
                showRecordDetail(recordId);
            }, 500);
        }
        
        // 点击表格外区域关闭浮窗
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('recordDetailModal');
            if (event.target === modal) {
                TimeRecorderRecordDetail.closeRecordDetailModal();
            }
        });
        
        // 添加键盘事件监听器，支持ESC键关闭模态框
        document.addEventListener('keydown', handleKeyDown);
        
        // 添加导入记录相关事件监听器
        const importBtn = document.getElementById('importRecordBtn');
        const fileInput = document.getElementById('recordFileInput');
        
        if (importBtn && fileInput) {
            // 点击导入按钮时触发文件选择
            importBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择后处理导入
            fileInput.addEventListener('change', function() {
                if (fileInput.files && fileInput.files.length > 0) {
                    importRecordFile(fileInput.files[0]);
                }
            });
        }
    });

    // 处理键盘事件
    function handleKeyDown(event) {
        // ESC键关闭模态框
        if (event.key === 'Escape') {
            TimeRecorderRecordDetail.closeRecordDetailModal();
        }
    }

    // 加载记录
    function loadRecords(page = 1) {
        // 使用模块化的API函数
        if (window.TimeRecorderAPI && typeof window.TimeRecorderAPI.loadAllRecords === 'function') {
            currentPage = page;
            
            // 获取筛选参数
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const activity = document.getElementById('activityFilter').value;
            const emotion = document.getElementById('emotionFilter').value;
            const search = document.getElementById('searchInput').value;
            
            // 构建查询参数
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('per_page', 20);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (activity) params.append('activity', activity);
            if (emotion) params.append('emotion', emotion);
            if (search) params.append('search', search);
            
            // 调用模块化的API函数
            window.TimeRecorderAPI.loadAllRecords(params)
                .then(data => {
                    if (data.success) {
                        updateRecordsTable(data.records);
                        updatePagination(data.pagination);
                        updateActivityFilter(data.records);
                    }
                })
                .catch(error => {
                    console.error('加载记录失败:', error);
                });
        } else {
            // 如果模块化函数不可用，使用原来的实现
            currentPage = page;
            
            // 获取筛选参数
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const activity = document.getElementById('activityFilter').value;
            const emotion = document.getElementById('emotionFilter').value;
            const search = document.getElementById('searchInput').value;
            
            // 构建查询参数
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('per_page', 20);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (activity) params.append('activity', activity);
            if (emotion) params.append('emotion', emotion);
            if (search) params.append('search', search);
            
            fetch(`/api/all-records?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateRecordsTable(data.records);
                        updatePagination(data.pagination);
                        updateActivityFilter(data.records);
                    }
                })
                .catch(error => {
                    console.error('加载记录失败:', error);
                });
        }
    }

    // 更新记录表格
    function updateRecordsTable(records) {
        const tbody = document.getElementById('recordsBody');
        tbody.innerHTML = '';
        
        records.forEach((record, index) => {
            const activityClass = TimeRecorderFrontendUtils.getActivityClass(record.activity, record.activityCategory);
            
            // 处理情绪显示，添加颜色
            const emotionDisplay = record.emotion ? 
                record.emotion.split(', ').map(e => 
                    `<span class="emotion-tag" style="background-color: ${TimeRecorderFrontendUtils.getEmotionColor(e)};">${e}</span>`
                ).join(' ') : '';
            
            // 根据规范，duration记录所有segments累计的时间
            // 重新计算段落总时间以确保准确性
            let totalDuration = 0;
            if (record.segments && Array.isArray(record.segments)) {
                // 使用工具类计算所有段落的总时间
                totalDuration = TimeRecorderFrontendUtils.calculateSegmentsTotalTime(record.segments);
            }
            // 如果计算结果为0，使用record.duration作为后备值
            if (totalDuration === 0) {
                totalDuration = (record && record.duration) || 0;
            }
            
            const row = tbody.insertRow();
            // 删除编辑按钮，只保留继续和删除按钮
            row.innerHTML = `
                <td>${record.date || (record.startTime ? record.startTime.substring(0, 10).replace(/-/g, '/') : '')}</td>
                <td><span class="activity-label ${activityClass}" onclick="showRecordDetail('${record.id}')">${record.activity}</span></td>
                <td>${TimeRecorderFrontendUtils.formatTime(new Date(record.startTime))}</td>
                <td>${TimeRecorderFrontendUtils.formatTime(new Date(record.endTime))}</td>
                <td>${TimeRecorderFrontendUtils.formatDuration(totalDuration)}</td>
                <td>${TimeRecorderFrontendUtils.formatDuration(record.timeSpan)}</td>
                <td>${record.remark || ''}</td>
                <td>${emotionDisplay}</td>
                <td>${record.pauseCount || 0}</td>
                <td>
                    <button class="continue-btn" onclick="continueActivity('${record.id}')">继续</button>
                    <button class="delete-btn" onclick="deleteRecord('${record.id}')">删除</button>
                </td>
            `;
        });
    }

    // 继续选中的活动
    function continueActivity(recordId) {
        // 通过API获取指定记录的详细信息
        fetch(`/api/records/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const record = data.record;
                    
                    // 重定向到首页并传递活动信息
                    // 使用localStorage传递数据
                    localStorage.setItem('continueActivity', JSON.stringify({
                        activity: record.activity,
                        activityCategory: record.activityCategory,
                        remark: record.remark || '',
                        emotion: record.emotion || '',
                        recordId: record.id, // 传递记录ID
                        autoStart: true // 标记需要自动开始计时
                    }));
                    
                    // 跳转到首页
                    window.location.href = '/';
                } else {
                    console.error('获取记录详情失败:', data.error);
                }
            })
            .catch(error => {
                console.error('获取记录详情失败:', error);
            });
    }

    // 显示记录详情浮窗
    function showRecordDetail(recordId) {
        // 使用统一的记录详情组件
        TimeRecorderRecordDetail.showRecordDetail(recordId);
    }

    // 更新时间跨度
    function updateTimeSpan(recordId) {
        const startTimeStr = document.getElementById('detail-start-time').value;
        const endTimeStr = document.getElementById('detail-end-time').value;
        
        if (startTimeStr && endTimeStr) {
            // 输入框中的时间已经是北京时间格式
            const startDate = new Date(startTimeStr);
            const endDate = new Date(endTimeStr);
            const timeSpan = endDate - startDate;
            
            document.getElementById('detail-time-span').value = TimeRecorderFrontendUtils.formatDuration(timeSpan);
        }
    }

    // 添加段落
    function addSegment(recordId) {
        const segmentsContainer = document.querySelector('.segments-display');
        const segmentCount = document.querySelectorAll('.segment-row[data-segment-index]').length;
        
        // 获取当前时间作为默认时间（使用北京时间）
        const now = new Date();
        const defaultTime = TimeRecorderFrontendUtils.formatDateTimeForInput(now);
        
        const newSegment = `
            <div class="segment-row" data-segment-index="${segmentCount}">
                <span>段落 ${segmentCount + 1}:</span>
                <input type="datetime-local" class="segment-start" value="${defaultTime}">
                <span> - </span>
                <input type="datetime-local" class="segment-end" value="${defaultTime}">
                <span>(0秒)</span>
                <button type="button" class="delete-btn small" onclick="deleteSegment('${recordId}', ${segmentCount})">删除</button>
            </div>
        `;
        
        // 在添加按钮前插入新段落
        const addButton = segmentsContainer.querySelector('button');
        segmentsContainer.insertBefore(document.createRange().createContextualFragment(newSegment), addButton);
    }

    // 删除段落
    function deleteSegment(recordId, segmentIndex) {
        const segmentRow = document.querySelector(`.segment-row[data-segment-index="${segmentIndex}"]`);
        if (segmentRow) {
            segmentRow.remove();
            // 重新编号剩余的段落
            renumberSegments();
        }
    }

    // 重新编号段落
    function renumberSegments() {
        const segmentRows = document.querySelectorAll('.segment-row[data-segment-index]');
        segmentRows.forEach((row, index) => {
            row.setAttribute('data-segment-index', index);
            row.querySelector('span').textContent = `段落 ${index + 1}:`;
            const deleteButton = row.querySelector('.delete-btn');
            if (deleteButton) {
                // 更新删除按钮的onclick属性
                deleteButton.setAttribute('onclick', deleteButton.getAttribute('onclick').replace(/\d+$/, index));
            }
        });
    }

    // 保存记录详情
    function saveRecordDetail(recordId) {
        const activity = document.getElementById('detail-activity').value;
        const activityCategory = document.getElementById('detail-activity-category').value;
        const startTimeStr = document.getElementById('detail-start-time').value;
        const endTimeStr = document.getElementById('detail-end-time').value;
        const remark = document.getElementById('detail-remark').value;
        
        // 获取选中的情绪
        const emotionCheckboxes = document.querySelectorAll('#detail-emotion input[type="checkbox"]:checked');
        const emotions = Array.from(emotionCheckboxes).map(cb => cb.value).join(', ');
        
        const pauseCount = document.getElementById('detail-pause-count').value;
        
        // 获取段落信息
        const segmentRows = document.querySelectorAll('.segment-row[data-segment-index]');
        const segments = [];
        segmentRows.forEach(row => {
            const startIndex = row.querySelector('.segment-start').value;
            const endIndex = row.querySelector('.segment-end').value;
            
            if (startIndex && endIndex) {
                try {
                    // 输入框中的时间已经是北京时间格式，需要转换为UTC时间存储
                    const beijingStart = new Date(startIndex);
                    const beijingEnd = new Date(endIndex);
                    // 转换为UTC时间存储（减去8小时偏移）
                    const utcStart = new Date(beijingStart.getTime() - 8 * 60 * 60 * 1000);
                    const utcEnd = new Date(beijingEnd.getTime() - 8 * 60 * 60 * 1000);
                    
                    if (!isNaN(utcStart.getTime()) && !isNaN(utcEnd.getTime())) {
                        segments.push({
                            start: utcStart.toISOString(),
                            end: utcEnd.toISOString()
                        });
                    }
                } catch (e) {
                    console.error('处理段落时间时出错:', e);
                }
            }
        });
        
        // 构造更新数据
        const updateData = {
            activity: activity,
            activityCategory: activityCategory,
            remark: remark,
            emotion: emotions,
            pauseCount: parseInt(pauseCount) || 0,
            segments: segments
        };
        
        // 更新时间
        if (startTimeStr && endTimeStr) {
            try {
                // 输入框中的时间已经是北京时间格式，需要转换为UTC时间存储
                const beijingStartDate = new Date(startTimeStr);
                const beijingEndDate = new Date(endTimeStr);
                // 转换为UTC时间存储（减去8小时偏移）
                const utcStartDate = new Date(beijingStartDate.getTime() - 8 * 60 * 60 * 1000);
                const utcEndDate = new Date(beijingEndDate.getTime() - 8 * 60 * 60 * 1000);
                
                if (!isNaN(utcStartDate.getTime()) && !isNaN(utcEndDate.getTime())) {
                    updateData.startTime = utcStartDate.toISOString();
                    updateData.endTime = utcEndDate.toISOString();
                    
                    // 重新计算时间跨度
                    const timeSpan = utcEndDate - utcStartDate;
                    updateData.timeSpan = timeSpan;
                }
            } catch (e) {
                console.error('处理时间时出错:', e);
            }
        }
        
        // 发送到后端更新
        fetch(`/api/records/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                TimeRecorderRecordDetail.closeRecordDetailModal();
                loadRecords(currentPage);
            } else {
                alert('更新记录失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('更新记录失败:', error);
            alert('更新记录失败，请查看控制台了解详情');
        });
    }

    // 更新分页控件
    function updatePagination(pagination) {
        totalPages = pagination.pages;
        const paginationEl = document.getElementById('pagination');
        
        let paginationHTML = '';
        
        // 上一页按钮
        if (currentPage > 1) {
            paginationHTML += `<button onclick="loadRecords(${currentPage - 1})">上一页</button>`;
        }
        
        // 页码按钮
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="active">${i}</button>`;
            } else {
                paginationHTML += `<button onclick="loadRecords(${i})">${i}</button>`;
            }
        }
        
        // 下一页按钮
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="loadRecords(${currentPage + 1})">下一页</button>`;
        }
        
        paginationEl.innerHTML = paginationHTML;
    }

    // 更新活动筛选下拉框
    function updateActivityFilter(records) {
        records.forEach(record => {
            allActivities.add(record.activity);
        });
        
        const activityFilter = document.getElementById('activityFilter');
        const currentSelection = activityFilter.value;
        
        // 清空现有选项（保留第一个"全部活动"选项）
        while (activityFilter.options.length > 1) {
            activityFilter.remove(1);
        }
        
        // 添加所有活动选项
        allActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity;
            option.text = activity;
            activityFilter.add(option);
        });
        
        // 恢复之前的选中项
        activityFilter.value = currentSelection;
    }

    // 应用筛选条件
    function applyFilters() {
        loadRecords(1);
    }

    // 重置筛选条件
    function resetFilters() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('activityFilter').value = '';
        document.getElementById('emotionFilter').value = '';
        document.getElementById('searchInput').value = '';
        loadRecords(1);
    }

    // 编辑记录
    function editRecord(recordId) {
        showRecordDetail(recordId);
    }

    // 删除记录
    function deleteRecord(recordId) {
        if (!confirm('确定要删除这条记录吗？')) {
            return;
        }
        
        fetch(`/api/records/${recordId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadRecords(currentPage);
            } else {
                alert('删除记录失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('删除记录失败:', error);
            alert('删除记录失败，请查看控制台了解详情');
        });
    }

    // 导出记录
    function exportRecords() {
        // 显示确认对话框
        if (!confirm('确定要导出所有记录吗？')) {
            return;
        }
        
        // 发送请求导出记录
        fetch(`/api/export-records`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 创建要下载的JSON数据
                    const jsonData = JSON.stringify(data.records, null, 2);
                    
                    // 创建Blob对象
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `records.json`;
                    
                    // 触发下载
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    alert(`成功导出 ${data.records.length} 条记录`);
                } else {
                    alert('导出记录失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('导出记录失败:', error);
                alert('导出记录失败，请查看控制台了解详情');
            });
    }

    // 导入记录文件函数
    function importRecordFile(file) {
        if (!file) {
            showImportStatus('请选择要导入的文件', 'error');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        showImportStatus('正在导入...', 'info');
        
        fetch('/api/import-records', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showImportStatus(`导入成功！共导入 ${data.imported_count} 条记录`, 'success');
                // 清空文件选择
                document.getElementById('recordFileInput').value = '';
                // 重新加载记录
                loadRecords();
            } else {
                showImportStatus(`导入失败: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('导入记录失败:', error);
            showImportStatus('导入失败，请查看控制台了解详情', 'error');
        });
    }
    
    // 显示导入状态
    function showImportStatus(message, type) {
        const importStatus = document.getElementById('importStatus');
        if (!importStatus) return;
        
        importStatus.textContent = message;
        importStatus.className = 'import-status ' + type;
        
        // 3秒后自动清除状态信息
        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                importStatus.textContent = '';
                importStatus.className = 'import-status';
            }, 3000);
        }
    }

    

    // 解析时间字符串为毫秒数
    function parseDurationString(durationStr) {
        // 使用模块化的工具函数
        if (window.TimeRecorderFrontendUtils && typeof window.TimeRecorderFrontendUtils.parseDurationString === 'function') {
            return window.TimeRecorderFrontendUtils.parseDurationString(durationStr);
        }
        
        // 如果模块化函数不可用，使用原来的实现
        const hourMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*小时/);
        const minuteMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*分钟/);
        const secondMatch = durationStr.match(/(\d+(?:\.\d+)?)\s*秒/);
        
        let totalMs = 0;
        
        if (hourMatch) {
            totalMs += parseFloat(hourMatch[1]) * 3600000;
        }
        
        if (minuteMatch) {
            totalMs += parseFloat(minuteMatch[1]) * 60000;
        }
        
        if (secondMatch) {
            totalMs += parseFloat(secondMatch[1]) * 1000;
        }
        
        // 如果没有匹配到任何单位，尝试直接解析数字作为分钟
        if (totalMs === 0 && !isNaN(parseFloat(durationStr))) {
            totalMs = parseFloat(durationStr) * 60000;
        }
        
        return totalMs > 0 ? Math.round(totalMs) : null;
    }

    // 获取情绪选项
    function getEmotionOptions() {
        return ['开心', '专注', '疲惫', '焦虑', '兴奋', '平静', '沮丧', '满足', '无聊'];
    }

    /**
     * 时间记录器前端工具类
     */
    const TimeRecorderFrontendUtils = {
        /**
         * 获取情绪颜色
         */
        getEmotionColor: function(emotion) {
            const emotionColorMap = {
                '开心': '#4CAF50',    // 绿色
                '专注': '#2196F3',    // 蓝色
                '疲惫': '#9E9E9E',    // 灰色
                '焦虑': '#FF9800',    // 橙色
                '兴奋': '#E91E63',    // 粉色
                '平静': '#00BCD4',    // 青色
                '沮丧': '#F44336',    // 红色
                '满足': '#8BC34A',    // 黄绿色
                '无聊': '#795548'     // 棕色
            };
            return emotionColorMap[emotion] || '#607D8B'; // 默认灰色
        },
        
        /**
         * 活动类别到CSS类的映射
         */
        getActivityCategoryClassMap: function() {
            return {
                // 工作输出类 - 蓝色系
                '工作输出': 'btn-work-output',
                
                // 大脑充电类 - 绿色系
                '大脑充电': 'btn-brain-charge',
                
                // 修养生息类 - 紫色系
                '修养生息': 'btn-rest',
                
                // 身体改善类 - 橙色系
                '身体改善': 'btn-body',
                
                // 沟通交流类 - 青色系
                '沟通交流': 'btn-communication',
                
                // 探索新方法类 - 深紫系
                '探索新方法': 'btn-explore',
                
                // 纯属娱乐类 - 粉色系
                '纯属娱乐': 'btn-entertainment',
                
                // 保持学习类 - 蓝绿系
                '保持学习': 'btn-learning',
                
                // 生活计划类 - 黄绿系
                '生活计划': 'btn-planning',
                
                // 规律作息类 - 灰色系
                '规律作息': 'btn-routine'
            };
        },
        
        /**
         * 获取活动类别对应的CSS类
         */
        getActivityCategoryClass: function(activityCategory) {
            const categoryClassMap = this.getActivityCategoryClassMap();
            return categoryClassMap[activityCategory] || 'btn-work-output'; // 默认使用工作输出类颜色
        },
        
        /**
         * 获取活动对应的CSS类（基于活动类别）
         */
        getActivityClass: function(activity, activityCategory) {
            if (activityCategory) {
                return this.getActivityCategoryClass(activityCategory);
            }
            // 如果没有活动类别，使用原来的映射
            const activityClassMap = {
                // 工作输出类 - 蓝色系
                '进入工作状态': 'btn-work-output',
                '梳理方案': 'btn-work-output',
                '执行工作': 'btn-work-output',
                '开会': 'btn-work-output',
                '复盘': 'btn-work-output',
                '探索新方法': 'btn-work-output',
                
                // 大脑充电类 - 绿色系
                '和智者对话': 'btn-brain-charge',
                '做调研': 'btn-learning',
                
                // 修养生息类 - 紫色系
                '睡觉仪式': 'btn-rest',
                '处理日常': 'btn-rest',
                
                // 身体改善类 - 橙色系
                '健身': 'btn-body',
                '创作/写作': 'btn-body',
                
                // 沟通交流类 - 青色系
                '交流心得': 'btn-communication',
                '散步': 'btn-communication',
                '记录|反思|计划': 'btn-communication',
                
                // 玩玩具属于纯属娱乐类 - 粉色系
                '玩玩具': 'btn-entertainment'
            };
            
            return activityClassMap[activity] || 'btn-work-output'; // 默认使用工作输出类颜色
        },
        
        /**
         * 计算段落总时间
         */
        calculateSegmentsTotalTime: function(segments) {
            let total = 0;
            if (segments && Array.isArray(segments)) {
                segments.forEach(segment => {
                    if (segment.start && segment.end) {
                        // 使用北京时间
                        const start = new Date(segment.start).getTime();
                        const end = new Date(segment.end).getTime();
                        total += (end - start);
                    }
                });
            }
            return total;
        },
        
        /**
         * 格式化时间
         */
        formatTime: function(date) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        },
        
        /**
         * 格式化日期时间用于输入框
         */
        formatDateTimeForInput: function(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        },
        
        /**
         * 格式化时长
         */
        formatDuration: function(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}小时${minutes}分钟`;
            } else {
                return `${minutes}分钟${seconds}秒`;
            }
        },
        
        /**
         * 切换详情区域的折叠/展开状态
         */
        toggleSection: function(button, sectionType) {
            const section = button.closest('.detail-section');
            const isCollapsed = section.classList.contains('collapsed');
            
            if (isCollapsed) {
                // 展开
                section.classList.remove('collapsed');
                button.textContent = '折叠';
                
                // 显示该区域的所有子元素
                const elements = section.querySelectorAll('div:not(.emotion-checkboxes), .emotion-checkboxes, .segments-display, .highlight-field');
                elements.forEach(el => {
                    if (el !== section.querySelector('h3')) {
                        el.style.display = '';
                    }
                });
            } else {
                // 折叠
                section.classList.add('collapsed');
                button.textContent = '展开';
                
                // 隐藏该区域的所有子元素
                const elements = section.querySelectorAll('div:not(.emotion-checkboxes), .emotion-checkboxes, .segments-display, .highlight-field');
                elements.forEach(el => {
                    if (el !== section.querySelector('h3')) {
                        el.style.display = 'none';
                    }
                });
            }
        }
    };
    
    // 全局函数，用于切换详情区域的折叠/展开状态
    function toggleSection(button, sectionType) {
        TimeRecorderFrontendUtils.toggleSection(button, sectionType);
    }
</script>
{% endblock %}