{% extends "base.html" %}

{% block title %}情绪墙与活动类型墙 - 时间追踪器{% endblock %}

{% block content %}
<h1>情绪墙与活动类型墙</h1>

<div class="mood-wall-header">
    <div class="navigation">
        <a href="/" class="nav-link">返回首页</a>
        <a href="/records" class="nav-link">历史记录</a>
        <a href="/project-description" class="nav-link">项目说明</a>
    </div>
    <div class="date-navigation">
        <button id="prevMonth" class="nav-btn">上个月</button>
        <span id="currentMonthDisplay"></span>
        <button id="nextMonth" class="nav-btn">下个月</button>
    </div>
</div>

<div class="wall-container">
    <div class="wall-section-container">
        <div class="wall-section">
            <h2>情绪墙</h2>
            <div id="moodWall" class="mood-wall-container"></div>
        </div>
        
        <div class="wall-section">
            <h2>活动类型墙</h2>
            <div id="activityWall" class="activity-wall-container"></div>
        </div>
    </div>
    
    <div class="wall-section">
        <h2>关键词词云（近7天）</h2>
        <div id="keywordCloud" class="keyword-cloud"></div>
    </div>
</div>

<div class="legend-section">
    <div class="legend-group">
        <h3>情绪图例</h3>
        <div id="moodLegend" class="legend-container"></div>
    </div>
    <div class="legend-group">
        <h3>活动类型图例</h3>
        <div id="activityLegend" class="legend-container"></div>
    </div>
</div>

<!-- 活动详情浮窗 -->
<div id="recordDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="TimeRecorderRecordDetail.closeRecordDetailModal()">&times;</span>
        <h2>活动详情</h2>
        <div id="recordDetailContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUsername = 'default';
    let currentDate = new Date();
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化用户名
        const savedUsername = localStorage.getItem('timeRecorderUsername');
        if (savedUsername) {
            currentUsername = savedUsername;
        } else {
            // 如果没有找到保存的用户名，尝试从URL参数获取
            const urlParams = new URLSearchParams(window.location.search);
            const urlUsername = urlParams.get('username');
            if (urlUsername) {
                currentUsername = urlUsername;
                // 保存到localStorage
                localStorage.setItem('timeRecorderUsername', urlUsername);
            }
        }
        
        // 初始化当前月份显示
        updateMonthDisplay();
        
        // 加载数据
        loadWallData();
        
        // 绑定事件
        document.getElementById('prevMonth').addEventListener('click', goToPrevMonth);
        document.getElementById('nextMonth').addEventListener('click', goToNextMonth);
    });
    
    // 更新月份显示
    function updateMonthDisplay() {
        const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月",
                           "7月", "8月", "9月", "10月", "11月", "12月"];
        const year = currentDate.getFullYear();
        const month = monthNames[currentDate.getMonth()];
        document.getElementById('currentMonthDisplay').textContent = `${year}年 ${month}`;
    }
    
    // 跳转到上个月
    function goToPrevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateMonthDisplay();
        loadWallData();
    }
    
    // 跳转到下个月
    function goToNextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateMonthDisplay();
        loadWallData();
    }
    
    // 加载情绪墙和活动类型墙数据
    function loadWallData() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // JavaScript的月份是从0开始的
        
        fetch(`/api/mood-wall?username=${encodeURIComponent(currentUsername)}&year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderMoodWall(data.moodData);
                    renderActivityWall(data.activityData);
                    renderKeywordCloud(data.keywordData);
                    renderMoodLegend(data.moodLegend);
                    renderActivityLegend(data.activityLegend);
                } else {
                    console.error('加载数据失败:', data.error);
                }
            })
            .catch(error => {
                console.error('加载数据失败:', error);
            });
    }
    
    // 渲染情绪墙
    function renderMoodWall(moodData) {
        const moodWall = document.getElementById('moodWall');
        moodWall.innerHTML = '';
        
        if (moodData.length === 0) {
            moodWall.innerHTML = '<p>近7天暂无情绪数据</p>';
            return;
        }
        
        // 获取最近7天的日期（最近的日期在上）
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.push(date);
        }
        
        // 渲染每天的情绪数据
        dates.forEach(date => {
            const dayStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            const dayRow = document.createElement('div');
            dayRow.className = 'mood-day-row';
            
            // 创建日期标签（完整的日期信息）
            const dateLabel = document.createElement('div');
            dateLabel.className = 'mood-date-label';
            dateLabel.textContent = `${date.getMonth() + 1}月${date.getDate()}日`;
            dayRow.appendChild(dateLabel);
            
            // 创建情绪容器
            const moodsContainer = document.createElement('div');
            moodsContainer.className = 'moods-container';
            
            // 收集当天的所有情绪
            const dayMoods = [];
            moodData.forEach(mood => {
                const dayData = mood.days.find(d => {
                    // 将记录中的日期转换为北京时间进行比较
                    const recordDate = new Date(d.date);
                    const recordDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth() + 1).padStart(2, '0')}/${String(recordDate.getDate()).padStart(2, '0')}`;
                    return recordDateStr === dayStr;
                });
                
                if (dayData && dayData.count > 0) {
                    for (let i = 0; i < dayData.count; i++) {
                        dayMoods.push({
                            name: mood.name,
                            color: mood.color,
                            date: dayStr,
                            recordId: dayData.record_ids && dayData.record_ids[i] ? dayData.record_ids[i] : null,
                            activity: dayData.activities && dayData.activities[i] ? dayData.activities[i] : '',
                            duration: dayData.durations && dayData.durations[i] ? dayData.durations[i] : 0
                        });
                    }
                }
            });
            
            // 渲染当天的情绪方块
            dayMoods.forEach((mood, index) => {
                const moodBox = document.createElement('div');
                moodBox.className = 'mood-box';
                moodBox.style.backgroundColor = mood.color;
                
                // 根据时长设置透明度，时间越短越透明（最小透明度0.3，最大1.0）
                const maxDuration = 1800000; // 30分钟为最大值参考，使透明度变化更明显
                const opacity = Math.max(0.3, Math.min(1.0, 0.3 + (mood.duration / maxDuration) * 0.7));
                moodBox.style.opacity = opacity;
                
                // 添加标题显示详细信息（活动名称和时长）
                const hours = Math.floor(mood.duration / (1000 * 60 * 60));
                const minutes = Math.floor((mood.duration % (1000 * 60 * 60)) / (1000 * 60));
                moodBox.title = `${mood.activity || mood.name}: ${hours}小时${minutes}分钟`;
                
                // 创建情绪文本
                const moodText = document.createElement('span');
                moodText.className = 'mood-text';
                moodText.textContent = mood.name;
                
                moodBox.appendChild(moodText);
                
                // 添加点击事件打开活动详情页
                moodBox.addEventListener('click', () => {
                    // 如果有recordId，直接使用recordId打开详情
                    if (mood.recordId) {
                        showRecordDetailById(mood.recordId);
                    } else {
                        // 查找匹配的情绪记录
                        findAndShowMoodDetail(mood.name, mood.date, index);
                    }
                });
                
                moodsContainer.appendChild(moodBox);
            });
            
            dayRow.appendChild(moodsContainer);
            moodWall.appendChild(dayRow);
        });
    }
    
    // 渲染活动类型墙
    function renderActivityWall(activityData) {
        const activityWall = document.getElementById('activityWall');
        activityWall.innerHTML = '';
        
        if (activityData.length === 0) {
            activityWall.innerHTML = '<p>近7天暂无活动数据</p>';
            return;
        }
        
        // 获取最近7天的日期（最近的日期在上）
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.push(date);
        }
        
        // 渲染每天的活动数据
        dates.forEach(date => {
            const dayStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            const dayRow = document.createElement('div');
            dayRow.className = 'activity-day-row';
            
            // 创建日期标签（完整的日期信息）
            const dateLabel = document.createElement('div');
            dateLabel.className = 'activity-date-label';
            dateLabel.textContent = `${date.getMonth() + 1}月${date.getDate()}日`;
            dayRow.appendChild(dateLabel);
            
            // 创建活动容器
            const activitiesContainer = document.createElement('div');
            activitiesContainer.className = 'activities-container';
            
            // 收集当天的所有活动
            const dayActivities = [];
            activityData.forEach(activity => {
                const dayData = activity.days.find(d => {
                    // 将记录中的日期转换为北京时间进行比较
                    const recordDate = new Date(d.date);
                    const recordDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth() + 1).padStart(2, '0')}/${String(recordDate.getDate()).padStart(2, '0')}`;
                    return recordDateStr === dayStr;
                });
                
                if (dayData && dayData.count > 0) {
                    for (let i = 0; i < dayData.count; i++) {
                        dayActivities.push({
                            name: activity.name,
                            color: activity.color,
                            duration: dayData.duration,
                            date: dayStr,
                            recordId: dayData.record_ids && dayData.record_ids[i] ? dayData.record_ids[i] : null,
                            activityCategory: dayData.activity_categories && dayData.activity_categories[i] ? dayData.activity_categories[i] : activity.name,
                            activity: dayData.activities && dayData.activities[i] ? dayData.activities[i] : ''
                        });
                    }
                }
            });
            
            // 渲染当天的活动方块
            dayActivities.forEach((activity, index) => {
                const activityBox = document.createElement('div');
                activityBox.className = 'activity-box';
                activityBox.style.backgroundColor = activity.color;
                
                // 根据时长设置透明度，时间越短越透明（最小透明度0.3，最大1.0）
                const maxDuration = 1800000; // 30分钟为最大值参考，使透明度变化更明显
                const opacity = Math.max(0.3, Math.min(1.0, 0.3 + (activity.duration / maxDuration) * 0.7));
                activityBox.style.opacity = opacity;
                
                // 添加标题显示详细信息
                const hours = Math.floor(activity.duration / (1000 * 60 * 60));
                const minutes = Math.floor((activity.duration % (1000 * 60 * 60)) / (1000 * 60));
                activityBox.title = `${activity.activity || activity.name}: ${hours}小时${minutes}分钟`;
                
                // 创建活动类型文本，显示活动类别而不是活动类别名称
                const activityText = document.createElement('span');
                activityText.className = 'activity-text';
                activityText.textContent = activity.activityCategory;
                
                activityBox.appendChild(activityText);
                
                // 添加点击事件打开活动详情页
                activityBox.addEventListener('click', () => {
                    // 如果有recordId，直接使用recordId打开详情
                    if (activity.recordId) {
                        showRecordDetailById(activity.recordId);
                    } else {
                        // 查找匹配的活动记录
                        findAndShowActivityDetail(activity.name, activity.date, index);
                    }
                });
                
                activitiesContainer.appendChild(activityBox);
            });
            
            dayRow.appendChild(activitiesContainer);
            activityWall.appendChild(dayRow);
        });
    }
    
    // 渲染情绪图例
    function renderMoodLegend(moodLegend) {
        const legendContainer = document.getElementById('moodLegend');
        legendContainer.innerHTML = '';
        
        moodLegend.forEach(mood => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = mood.color;
            
            const label = document.createElement('span');
            label.className = 'legend-label';
            label.textContent = mood.name;
            
            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendContainer.appendChild(legendItem);
        });
    }
    
    // 渲染活动类型图例
    function renderActivityLegend(activityLegend) {
        const legendContainer = document.getElementById('activityLegend');
        legendContainer.innerHTML = '';
        
        activityLegend.forEach(activity => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = activity.color;
            
            const label = document.createElement('span');
            label.className = 'legend-label';
            label.textContent = activity.name;
            
            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendContainer.appendChild(legendItem);
        });
    }
    
    // 渲染关键词词云
    function renderKeywordCloud(keywordData) {
        const cloudContainer = document.getElementById('keywordCloud');
        cloudContainer.innerHTML = '';
        
        if (keywordData.length === 0) {
            cloudContainer.innerHTML = '<p>近7天暂无关键词数据</p>';
            return;
        }
        
        keywordData.forEach(keyword => {
            const keywordItem = document.createElement('div');
            keywordItem.className = 'keyword-item';
            keywordItem.style.backgroundColor = keyword.color;
            
            // 根据出现次数调整字体大小
            const baseFontSize = 14;
            const fontSize = baseFontSize + (keyword.count * 2);
            keywordItem.style.fontSize = `${fontSize}px`;
            
            // 添加标题显示详细信息
            keywordItem.title = `${keyword.keyword}: 出现${keyword.count}次`;
            
            // 创建关键词文本
            const keywordText = document.createElement('span');
            keywordText.textContent = keyword.keyword;
            
            // 创建次数显示
            const countSpan = document.createElement('span');
            countSpan.className = 'keyword-count';
            countSpan.textContent = keyword.count;
            
            keywordItem.appendChild(keywordText);
            keywordItem.appendChild(countSpan);
            
            cloudContainer.appendChild(keywordItem);
        });
    }
    
    // 查找并显示活动详情
    function findAndShowActivityDetail(activityName, dateStr, index) {
        // 构造查询参数
        const params = new URLSearchParams();
        params.append('username', currentUsername);
        params.append('date_from', dateStr);
        params.append('date_to', dateStr);
        params.append('page', 1);
        params.append('per_page', 50); // 增加数量以确保能找到匹配的记录
        
        console.log('查找活动详情:', {activityName, dateStr, username: currentUsername});
        
        // 获取匹配的记录
        fetch(`/api/all-records?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('API响应:', data);
                if (data.success && data.records && data.records.length > 0) {
                    // 在返回的记录中查找匹配活动名称的记录
                    // 使用index来选择第几个匹配的记录
                    let matchingRecords = data.records.filter(record => 
                        record.activityCategory === activityName || record.activity.includes(activityName)
                    );
                    
                    if (matchingRecords.length > 0) {
                        // 如果有多个匹配记录，使用index来选择
                        const recordIndex = index % matchingRecords.length;
                        showRecordDetail(matchingRecords[recordIndex]);
                    } else {
                        // 如果没有精确匹配，尝试模糊匹配
                        matchingRecords = data.records.filter(record => 
                            record.activity.includes(activityName)
                        );
                        
                        if (matchingRecords.length > 0) {
                            const recordIndex = index % matchingRecords.length;
                            showRecordDetail(matchingRecords[recordIndex]);
                        } else {
                            alert(`未找到匹配的活动记录\n活动: ${activityName}\n日期: ${dateStr}`);
                        }
                    }
                } else {
                    alert(`未找到匹配的活动记录\n活动: ${activityName}\n日期: ${dateStr}`);
                }
            })
            .catch(error => {
                console.error('加载记录详情失败:', error);
                alert('加载记录详情失败，请查看控制台了解详情');
            });
    }
    
    // 查找并显示情绪详情
    function findAndShowMoodDetail(moodName, dateStr, index) {
        // 构造查询参数
        const params = new URLSearchParams();
        params.append('username', currentUsername);
        params.append('date_from', dateStr);
        params.append('date_to', dateStr);
        params.append('page', 1);
        params.append('per_page', 50);
        
        console.log('查找情绪详情:', {moodName, dateStr, username: currentUsername});
        
        // 获取匹配的记录
        fetch(`/api/all-records?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('API响应:', data);
                if (data.success && data.records && data.records.length > 0) {
                    // 在返回的记录中查找包含指定情绪的记录
                    // 使用index来选择第几个匹配的记录
                    let matchingRecords = data.records.filter(record => 
                        record.emotion && record.emotion.includes(moodName)
                    );
                    
                    if (matchingRecords.length > 0) {
                        // 如果有多个匹配记录，使用index来选择
                        const recordIndex = index % matchingRecords.length;
                        showRecordDetail(matchingRecords[recordIndex]);
                    } else {
                        alert(`未找到匹配的情绪记录\n情绪: ${moodName}\n日期: ${dateStr}`);
                    }
                } else {
                    alert(`未找到匹配的情绪记录\n情绪: ${moodName}\n日期: ${dateStr}`);
                }
            })
            .catch(error => {
                console.error('加载记录详情失败:', error);
                alert('加载记录详情失败，请查看控制台了解详情');
            });
    }
    
    // 显示记录详情
    function showRecordDetail(record) {
        // 使用统一的记录详情组件
        TimeRecorderRecordDetail.showRecordDetail(record);
    }
    
    // 通过recordId显示记录详情
    function showRecordDetailById(recordId) {
        // 使用统一的记录详情组件，直接传入recordId
        TimeRecorderRecordDetail.showRecordDetail(recordId);
    }
    
    // 切换情绪选择
    function toggleEmotion(emotion) {
        const emotionElement = document.querySelector(`.emotion-checkbox[data-emotion="${emotion}"]`);
        const checkbox = document.getElementById(`emotion-${emotion}`);
        
        if (emotionElement && checkbox) {
            // 切换选中状态
            const isSelected = emotionElement.classList.contains('selected');
            
            if (isSelected) {
                emotionElement.classList.remove('selected');
                checkbox.checked = false;
                
                // 添加取消选中的视觉反馈
                emotionElement.style.transform = 'translateY(0) scale(0.95)';
                setTimeout(() => {
                    emotionElement.style.transform = '';
                }, 150);
            } else {
                emotionElement.classList.add('selected');
                checkbox.checked = true;
                
                // 添加选中的视觉反馈
                emotionElement.style.transform = 'translateY(-2px) scale(1.05)';
                setTimeout(() => {
                    emotionElement.style.transform = '';
                }, 150);
                
                // 添加触觉反馈（如果设备支持）
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }
    }
    
    // 获取情绪颜色
    function getEmotionColor(emotion) {
        const emotionColors = {
            // 正向+专注：惊奇、兴奋、高兴、愉悦
            '惊奇': '#9C27B0',  // 紫色
            '兴奋': '#E91E63',  // 粉色
            '高兴': '#4CAF50',  // 绿色
            '愉悦': '#8BC34A',  // 浅绿色
            
            // 正向+松弛：安逸、安心、满足、宁静、放松
            '安逸': '#00BCD4',  // 青色
            '安心': '#2196F3',  // 蓝色
            '满足': '#8BC34A',  // 浅绿色
            '宁静': '#009688',  // 青绿色
            '放松': '#CDDC39',  // 青黄色
            
            // 负面+松弛：悲伤、伤心、沮丧、疲惫
            '悲伤': '#546E7A',  // 更暗的蓝灰色
            '伤心': '#78909C',  // 更暗的灰色
            '沮丧': '#5D4037',  // 暗棕色
            '疲惫': '#4E342E',  // 更暗的棕色
            
            // 负面+专注：惊恐、紧张、愤怒、苦恼
            '惊恐': '#424242',  // 暗灰色
            '紧张': '#616161',  // 更暗的灰色
            '愤怒': '#BF360C',  // 暗红色
            '苦恼': '#FF6F00'   // 暗琥珀色
        };
        return emotionColors[emotion] || '#607D8B';
    }
    
    // 生成情绪选择HTML（按象限分组）
    function generateEmotionCheckboxes(selectedEmotions = []) {
        // 按象限分组情绪选项
        const emotionGroups = {
            '正向+专注': { emotions: ['惊奇', '兴奋', '高兴', '愉悦'], color: '#4CAF50' },
            '正向+松弛': { emotions: ['安逸', '安心', '满足', '宁静', '放松'], color: '#00BCD4' },
            '负面+松弛': { emotions: ['悲伤', '伤心', '沮丧', '疲惫'], color: '#9E9E9E' },
            '负面+专注': { emotions: ['惊恐', '紧张', '愤怒', '苦恼'], color: '#F44336' }
        };
        
        return Object.entries(emotionGroups).map(([groupName, groupData]) => `
            <div class="emotion-quadrant">
                <div class="emotion-quadrant-title">${groupName}</div>
                <div class="emotion-quadrant-grid">
                    ${groupData.emotions.map(emotion => `
                        <div class="emotion-checkbox ${selectedEmotions.includes(emotion) ? 'selected' : ''}" 
                            data-emotion="${emotion}" 
                            onclick="toggleEmotion('${emotion}')"
                            style="background-color: ${getEmotionColor(emotion)};">
                            <input type="checkbox" id="emotion-${emotion}" value="${emotion}" 
                                ${selectedEmotions.includes(emotion) ? 'checked' : ''}>
                            <label for="emotion-${emotion}">${emotion}</label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    // 关闭记录详情浮窗
    function closeRecordDetailModal() {
        const modal = document.getElementById('recordDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        // 移除键盘事件监听器
        document.removeEventListener('keydown', handleKeyDown);
    }
    
    // 处理键盘事件
    function handleKeyDown(event) {
        // ESC键关闭模态框
        if (event && event.key === 'Escape') {
            closeRecordDetailModal();
        }
    }
    
    // 格式化时间显示
    function formatTime(timeStr) {
        if (!timeStr) return '';
        try {
            // 将UTC时间转换为北京时间显示
            const utcTime = new Date(timeStr);
            const beijingTime = new Date(utcTime.getTime() + 8 * 60 * 60 * 1000);
            return beijingTime.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('格式化时间出错:', e);
            return timeStr;
        }
    }
    
    // 格式化持续时间显示
    function formatDuration(milliseconds) {
        if (!milliseconds) return '0秒';
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
            return `${hours}小时${minutes % 60}分${seconds % 60}秒`;
        } else if (minutes > 0) {
            return `${minutes}分${seconds % 60}秒`;
        } else {
            return `${seconds}秒`;
        }
    }
</script>
{% endblock %}