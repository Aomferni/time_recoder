{% extends "base.html" %}

{% block title %}情绪墙与活动类型墙 - 时间追踪器{% endblock %}

{% block content %}
<h1>情绪墙与活动类型墙（<span id="currentUsernameDisplay">default</span>）</h1>

<div class="mood-wall-header">
    <div class="navigation">
        <a href="/" class="nav-link">返回首页</a>
        <a href="/records" class="nav-link">历史记录</a>
        <a href="/project-description" class="nav-link">项目说明</a>
    </div>
    <div class="date-navigation">
        <button id="prevMonth" class="nav-btn">上个月</button>
        <span id="currentMonthDisplay"></span>
        <button id="nextMonth" class="nav-btn">下个月</button>
    </div>
</div>

<div class="wall-container">
    <div class="wall-section">
        <h2>情绪墙</h2>
        <div id="moodWall" class="mood-wall-container"></div>
    </div>
    
    <div class="wall-section">
        <h2>活动类型墙</h2>
        <div id="activityWall" class="activity-wall-container"></div>
    </div>
    
    <div class="wall-section">
        <h2>关键词词云（近7天）</h2>
        <div id="keywordCloud" class="keyword-cloud"></div>
    </div>
</div>

<div class="legend-section">
    <div class="legend-group">
        <h3>情绪图例</h3>
        <div id="moodLegend" class="legend-container"></div>
    </div>
    <div class="legend-group">
        <h3>活动类型图例</h3>
        <div id="activityLegend" class="legend-container"></div>
    </div>
</div>

<!-- 活动详情浮窗 -->
<div id="recordDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeRecordDetailModal()">&times;</span>
        <h2>活动详情</h2>
        <div id="recordDetailContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUsername = 'default';
    let currentDate = new Date();
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化用户名
        const savedUsername = localStorage.getItem('timeRecorderUsername');
        if (savedUsername) {
            currentUsername = savedUsername;
            document.getElementById('currentUsernameDisplay').textContent = savedUsername;
        } else {
            // 如果没有找到保存的用户名，尝试从URL参数获取
            const urlParams = new URLSearchParams(window.location.search);
            const urlUsername = urlParams.get('username');
            if (urlUsername) {
                currentUsername = urlUsername;
                document.getElementById('currentUsernameDisplay').textContent = urlUsername;
                // 同时保存到localStorage
                localStorage.setItem('timeRecorderUsername', urlUsername);
            }
        }
        
        // 初始化当前月份显示
        updateMonthDisplay();
        
        // 加载数据
        loadWallData();
        
        // 绑定事件
        document.getElementById('prevMonth').addEventListener('click', goToPrevMonth);
        document.getElementById('nextMonth').addEventListener('click', goToNextMonth);
    });
    
    // 更新月份显示
    function updateMonthDisplay() {
        const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月",
                           "7月", "8月", "9月", "10月", "11月", "12月"];
        const year = currentDate.getFullYear();
        const month = monthNames[currentDate.getMonth()];
        document.getElementById('currentMonthDisplay').textContent = `${year}年 ${month}`;
    }
    
    // 跳转到上个月
    function goToPrevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateMonthDisplay();
        loadWallData();
    }
    
    // 跳转到下个月
    function goToNextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateMonthDisplay();
        loadWallData();
    }
    
    // 加载情绪墙和活动类型墙数据
    function loadWallData() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // JavaScript的月份是从0开始的
        
        fetch(`/api/mood-wall?username=${encodeURIComponent(currentUsername)}&year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderMoodWall(data.moodData);
                    renderActivityWall(data.activityData);
                    renderKeywordCloud(data.keywordData);
                    renderMoodLegend(data.moodLegend);
                    renderActivityLegend(data.activityLegend);
                } else {
                    console.error('加载数据失败:', data.error);
                }
            })
            .catch(error => {
                console.error('加载数据失败:', error);
            });
    }
    
    // 渲染情绪墙
    function renderMoodWall(moodData) {
        const moodWall = document.getElementById('moodWall');
        moodWall.innerHTML = '';
        
        if (moodData.length === 0) {
            moodWall.innerHTML = '<p>近7天暂无情绪数据</p>';
            return;
        }
        
        // 获取最近7天的日期（最近的日期在上）
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.push(date);
        }
        
        // 渲染每天的情绪数据
        dates.forEach(date => {
            const dayStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            const dayRow = document.createElement('div');
            dayRow.className = 'mood-day-row';
            
            // 创建日期标签（完整的日期信息）
            const dateLabel = document.createElement('div');
            dateLabel.className = 'mood-date-label';
            dateLabel.textContent = `${date.getMonth() + 1}月${date.getDate()}日`;
            dayRow.appendChild(dateLabel);
            
            // 创建情绪容器
            const moodsContainer = document.createElement('div');
            moodsContainer.className = 'moods-container';
            
            // 收集当天的所有情绪
            const dayMoods = [];
            moodData.forEach(mood => {
                const dayData = mood.days.find(d => {
                    // 将记录中的日期转换为北京时间进行比较
                    const recordDate = new Date(d.date);
                    const recordDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth() + 1).padStart(2, '0')}/${String(recordDate.getDate()).padStart(2, '0')}`;
                    return recordDateStr === dayStr;
                });
                
                if (dayData && dayData.count > 0) {
                    for (let i = 0; i < dayData.count; i++) {
                        dayMoods.push({
                            name: mood.name,
                            color: mood.color,
                            date: dayStr
                        });
                    }
                }
            });
            
            // 渲染当天的情绪方块
            dayMoods.forEach((mood, index) => {
                const moodBox = document.createElement('div');
                moodBox.className = 'mood-box';
                moodBox.style.backgroundColor = mood.color;
                
                // 添加标题显示详细信息
                moodBox.title = `${mood.name}`;
                
                // 创建情绪文本
                const moodText = document.createElement('span');
                moodText.className = 'mood-text';
                moodText.textContent = mood.name;
                
                moodBox.appendChild(moodText);
                
                // 添加点击事件打开活动详情页
                moodBox.addEventListener('click', () => {
                    // 查找匹配的情绪记录
                    findAndShowMoodDetail(mood.name, mood.date, index);
                });
                
                moodsContainer.appendChild(moodBox);
            });
            
            dayRow.appendChild(moodsContainer);
            moodWall.appendChild(dayRow);
        });
    }
    
    // 渲染活动类型墙
    function renderActivityWall(activityData) {
        const activityWall = document.getElementById('activityWall');
        activityWall.innerHTML = '';
        
        if (activityData.length === 0) {
            activityWall.innerHTML = '<p>近7天暂无活动数据</p>';
            return;
        }
        
        // 获取最近7天的日期（最近的日期在上）
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            dates.push(date);
        }
        
        // 渲染每天的活动数据
        dates.forEach(date => {
            const dayStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            const dayRow = document.createElement('div');
            dayRow.className = 'activity-day-row';
            
            // 创建日期标签（完整的日期信息）
            const dateLabel = document.createElement('div');
            dateLabel.className = 'activity-date-label';
            dateLabel.textContent = `${date.getMonth() + 1}月${date.getDate()}日`;
            dayRow.appendChild(dateLabel);
            
            // 创建活动容器
            const activitiesContainer = document.createElement('div');
            activitiesContainer.className = 'activities-container';
            
            // 收集当天的所有活动
            const dayActivities = [];
            activityData.forEach(activity => {
                const dayData = activity.days.find(d => {
                    // 将记录中的日期转换为北京时间进行比较
                    const recordDate = new Date(d.date);
                    const recordDateStr = `${recordDate.getFullYear()}/${String(recordDate.getMonth() + 1).padStart(2, '0')}/${String(recordDate.getDate()).padStart(2, '0')}`;
                    return recordDateStr === dayStr;
                });
                
                if (dayData && dayData.count > 0) {
                    for (let i = 0; i < dayData.count; i++) {
                        dayActivities.push({
                            name: activity.name,
                            color: activity.color,
                            duration: dayData.duration,
                            date: dayStr
                        });
                    }
                }
            });
            
            // 渲染当天的活动方块
            dayActivities.forEach((activity, index) => {
                const activityBox = document.createElement('div');
                activityBox.className = 'activity-box';
                activityBox.style.backgroundColor = activity.color;
                
                // 添加标题显示详细信息
                const hours = Math.floor(activity.duration / (1000 * 60 * 60));
                const minutes = Math.floor((activity.duration % (1000 * 60 * 60)) / (1000 * 60));
                activityBox.title = `${activity.name}: ${hours}小时${minutes}分钟`;
                
                // 创建活动类型文本
                const activityText = document.createElement('span');
                activityText.className = 'activity-text';
                activityText.textContent = activity.name;
                
                activityBox.appendChild(activityText);
                
                // 添加点击事件打开活动详情页
                activityBox.addEventListener('click', () => {
                    // 查找匹配的活动记录
                    findAndShowActivityDetail(activity.name, activity.date, index);
                });
                
                activitiesContainer.appendChild(activityBox);
            });
            
            dayRow.appendChild(activitiesContainer);
            activityWall.appendChild(dayRow);
        });
    }
    
    // 渲染情绪图例
    function renderMoodLegend(moodLegend) {
        const legendContainer = document.getElementById('moodLegend');
        legendContainer.innerHTML = '';
        
        moodLegend.forEach(mood => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = mood.color;
            
            const label = document.createElement('span');
            label.className = 'legend-label';
            label.textContent = mood.name;
            
            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendContainer.appendChild(legendItem);
        });
    }
    
    // 渲染活动类型图例
    function renderActivityLegend(activityLegend) {
        const legendContainer = document.getElementById('activityLegend');
        legendContainer.innerHTML = '';
        
        activityLegend.forEach(activity => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            
            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = activity.color;
            
            const label = document.createElement('span');
            label.className = 'legend-label';
            label.textContent = activity.name;
            
            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendContainer.appendChild(legendItem);
        });
    }
    
    // 渲染关键词词云
    function renderKeywordCloud(keywordData) {
        const cloudContainer = document.getElementById('keywordCloud');
        cloudContainer.innerHTML = '';
        
        if (keywordData.length === 0) {
            cloudContainer.innerHTML = '<p>近7天暂无关键词数据</p>';
            return;
        }
        
        keywordData.forEach(keyword => {
            const keywordItem = document.createElement('div');
            keywordItem.className = 'keyword-item';
            keywordItem.style.backgroundColor = keyword.color;
            
            // 根据出现次数调整字体大小
            const baseFontSize = 14;
            const fontSize = baseFontSize + (keyword.count * 2);
            keywordItem.style.fontSize = `${fontSize}px`;
            
            // 添加标题显示详细信息
            keywordItem.title = `${keyword.keyword}: 出现${keyword.count}次`;
            
            // 创建关键词文本
            const keywordText = document.createElement('span');
            keywordText.textContent = keyword.keyword;
            
            // 创建次数显示
            const countSpan = document.createElement('span');
            countSpan.className = 'keyword-count';
            countSpan.textContent = keyword.count;
            
            keywordItem.appendChild(keywordText);
            keywordItem.appendChild(countSpan);
            
            cloudContainer.appendChild(keywordItem);
        });
    }
    
    // 查找并显示活动详情
    function findAndShowActivityDetail(activityName, dateStr, index) {
        // 构造查询参数
        const params = new URLSearchParams();
        params.append('username', currentUsername);
        params.append('date_from', dateStr);
        params.append('date_to', dateStr);
        params.append('page', 1);
        params.append('per_page', 50); // 增加数量以确保能找到匹配的记录
        
        console.log('查找活动详情:', {activityName, dateStr, username: currentUsername});
        
        // 获取匹配的记录
        fetch(`/api/all-records?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('API响应:', data);
                if (data.success && data.records && data.records.length > 0) {
                    // 在返回的记录中查找匹配活动名称的记录
                    // 使用index来选择第几个匹配的记录
                    let matchingRecords = data.records.filter(record => 
                        record.activityCategory === activityName || record.activity.includes(activityName)
                    );
                    
                    if (matchingRecords.length > 0) {
                        // 如果有多个匹配记录，使用index来选择
                        const recordIndex = index % matchingRecords.length;
                        showRecordDetail(matchingRecords[recordIndex]);
                    } else {
                        // 如果没有精确匹配，尝试模糊匹配
                        matchingRecords = data.records.filter(record => 
                            record.activity.includes(activityName)
                        );
                        
                        if (matchingRecords.length > 0) {
                            const recordIndex = index % matchingRecords.length;
                            showRecordDetail(matchingRecords[recordIndex]);
                        } else {
                            alert(`未找到匹配的活动记录\n活动: ${activityName}\n日期: ${dateStr}`);
                        }
                    }
                } else {
                    alert(`未找到匹配的活动记录\n活动: ${activityName}\n日期: ${dateStr}`);
                }
            })
            .catch(error => {
                console.error('加载记录详情失败:', error);
                alert('加载记录详情失败，请查看控制台了解详情');
            });
    }
    
    // 查找并显示情绪详情
    function findAndShowMoodDetail(moodName, dateStr, index) {
        // 构造查询参数
        const params = new URLSearchParams();
        params.append('username', currentUsername);
        params.append('date_from', dateStr);
        params.append('date_to', dateStr);
        params.append('page', 1);
        params.append('per_page', 50);
        
        console.log('查找情绪详情:', {moodName, dateStr, username: currentUsername});
        
        // 获取匹配的记录
        fetch(`/api/all-records?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('API响应:', data);
                if (data.success && data.records && data.records.length > 0) {
                    // 在返回的记录中查找包含指定情绪的记录
                    // 使用index来选择第几个匹配的记录
                    let matchingRecords = data.records.filter(record => 
                        record.emotion && record.emotion.includes(moodName)
                    );
                    
                    if (matchingRecords.length > 0) {
                        // 如果有多个匹配记录，使用index来选择
                        const recordIndex = index % matchingRecords.length;
                        showRecordDetail(matchingRecords[recordIndex]);
                    } else {
                        alert(`未找到匹配的情绪记录\n情绪: ${moodName}\n日期: ${dateStr}`);
                    }
                } else {
                    alert(`未找到匹配的情绪记录\n情绪: ${moodName}\n日期: ${dateStr}`);
                }
            })
            .catch(error => {
                console.error('加载记录详情失败:', error);
                alert('加载记录详情失败，请查看控制台了解详情');
            });
    }
    
    // 显示记录详情
    function showRecordDetail(record) {
        const modal = document.getElementById('recordDetailModal');
        const content = document.getElementById('recordDetailContent');
        
        if (!modal || !content) {
            console.error('找不到模态框元素');
            return;
        }
        
        // 计算总时长
        const totalDuration = (record && record.duration) || 0;
        
        // 处理情绪显示，添加颜色
        let emotionDisplay = '';
        if (record.emotion) {
            const emotions = record.emotion.split(', ');
            emotionDisplay = emotions.map(e => {
                const span = document.createElement('span');
                span.className = 'emotion-tag';
                span.style.backgroundColor = getEmotionColor(e);
                span.textContent = e;
                return span.outerHTML;
            }).join(' ');
        }
        
        // 处理段落信息显示
        let segmentsDisplay = '';
        if (record.segments && Array.isArray(record.segments) && record.segments.length > 0) {
            // 计算每个段落的持续时间
            const segmentDetails = record.segments.map((segment, index) => {
                if (!segment || !segment.start || !segment.end) return null;
                
                try {
                    // 数据存储的是UTC时间，需要转换为北京时间显示
                    const start = new Date(segment.start);
                    const end = new Date(segment.end);
                    // 转换为北京时间（UTC+8）
                    const beijingStart = new Date(start.getTime());
                    const beijingEnd = new Date(end.getTime());
                    const duration = beijingEnd - beijingStart;
                    return {
                        index,
                        start: beijingStart,
                        end: beijingEnd,
                        duration
                    };
                } catch (e) {
                    console.error('处理段落信息时出错:', e);
                    return null;
                }
            }).filter(Boolean); // 过滤掉无效的段落
            
            if (segmentDetails.length > 0) {
                // 生成段落显示内容
                segmentsDisplay = segmentDetails.map(segment => {
                    return `
                        <div class="segment-row">
                            <span>段落 ${segment.index + 1}:</span>
                            <span>${formatTime(segment.start)} - ${formatTime(segment.end)}</span>
                            <span>(${formatDuration(segment.duration)})</span>
                        </div>
                    `;
                }).join('');
                
                // 添加段落统计信息
                const totalSegmentDuration = segmentDetails.reduce((total, segment) => total + segment.duration, 0);
                segmentsDisplay += `
                    <div class="segment-summary">
                        <p>段落数量: ${segmentDetails.length}</p>
                        <p>段落总时长: ${formatDuration(totalSegmentDuration)}</p>
                    </div>
                `;
            } else {
                segmentsDisplay = '<div class="segment-row">暂无有效段落记录</div>';
            }
        } else {
            segmentsDisplay = '<div class="segment-row">暂无段落记录</div>';
        }
        
        // 构建详情内容
        const detailContent = `
            <div class="detail-section highlight-section">
                <h3>记录收获</h3>
                <div class="highlight-field important-field">
                    ${record.remark || '暂无收获记录'}
                </div>
            </div>
            
            <div class="detail-section highlight-section">
                <h3>核心信息</h3>
                <div class="highlight-field important-field">
                    <label>活动名称:</label>
                    <span>${record.activity || ''}</span>
                </div>
                
                <div class="highlight-field">
                    <label>活动类别:</label>
                    <span>${record.activityCategory || '未分类'}</span>
                </div>
                
                <div class="highlight-field">
                    <label>记录日期:</label>
                    <span>${record.date || (record.startTime ? record.startTime.substring(0, 10).replace(/-/g, '/') : '')}</span>
                </div>
            </div>
            
            <div class="detail-section highlight-section">
                <h3>时间信息</h3>
                <div class="highlight-field">
                    <label>开始时间:</label>
                    <span>${record.startTime ? formatTime(new Date(record.startTime)) : ''}</span>
                </div>
                
                <div class="highlight-field">
                    <label>结束时间:</label>
                    <span>${record.endTime ? formatTime(new Date(record.endTime)) : ''}</span>
                </div>
                
                <div class="highlight-field">
                    <label>时间跨度:</label>
                    <span>${record.timeSpan ? formatDuration(record.timeSpan) : '0分钟0秒'}</span>
                </div>
                
                <div class="highlight-field important-field">
                    <label>计时时长:</label>
                    <span>${formatDuration(totalDuration)}</span>
                </div>
                
                <div class="highlight-field important-field">
                    <label>暂停次数:</label>
                    <span>${record.pauseCount || 0}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <h3>记录情绪</h3>
                <div class="highlight-field">
                    <label>情绪:</label>
                    <span>${emotionDisplay || '无'}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <h3>段落详情</h3>
                <div class="segments-display">
                    ${segmentsDisplay}
                </div>
            </div>
            
            <div class="detail-actions">
                <button type="button" class="cancel-btn" onclick="closeRecordDetailModal()">关闭</button>
            </div>
        `;
        
        content.innerHTML = detailContent;
        modal.style.display = 'block';
        
        // 添加键盘事件监听器，支持ESC键关闭模态框
        document.addEventListener('keydown', handleKeyDown);
    }
    
    // 获取情绪颜色
    function getEmotionColor(emotion) {
        const emotionColors = {
            '开心': '#4CAF50',
            '专注': '#2196F3',
            '疲惫': '#9E9E9E',
            '焦虑': '#FF9800',
            '兴奋': '#E91E63',
            '平静': '#00BCD4',
            '沮丧': '#F44336',
            '满足': '#8BC34A',
            '无聊': '#795548'
        };
        return emotionColors[emotion] || '#607D8B';
    }
    
    // 关闭记录详情浮窗
    function closeRecordDetailModal() {
        const modal = document.getElementById('recordDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        // 移除键盘事件监听器
        document.removeEventListener('keydown', handleKeyDown);
    }
    
    // 处理键盘事件
    function handleKeyDown(event) {
        // ESC键关闭模态框
        if (event && event.key === 'Escape') {
            closeRecordDetailModal();
        }
    }
    
    // 格式化时间显示
    function formatTime(timeStr) {
        if (!timeStr) return '';
        try {
            // 将UTC时间转换为北京时间显示
            const utcTime = new Date(timeStr);
            const beijingTime = new Date(utcTime.getTime() + 8 * 60 * 60 * 1000);
            return beijingTime.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        } catch (e) {
            console.error('格式化时间出错:', e);
            return timeStr;
        }
    }
    
    // 格式化持续时间显示
    function formatDuration(milliseconds) {
        if (!milliseconds) return '0秒';
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        if (hours > 0) {
            return `${hours}小时${minutes % 60}分${seconds % 60}秒`;
        } else if (minutes > 0) {
            return `${minutes}分${seconds % 60}秒`;
        } else {
            return `${seconds}秒`;
        }
    }
</script>
{% endblock %}