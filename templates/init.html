<script>
    function startInitialization() {
        // 显示飞书配置模态框
        showFeishuConfig();
    }
    
    function skipInitialization() {
        if (confirm('跳过配置将无法使用飞书集成功能，确定要跳过吗？')) {
            // 发送跳过初始化的请求
            fetch('/api/init/skip', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 跳转到主页
                    window.location.href = '/';
                } else {
                    alert('跳过初始化失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('跳过初始化失败:', error);
                alert('跳过初始化失败，请查看控制台了解详情');
            });
        }
    }
    
    function showFeishuConfig() {
        // 获取当前飞书配置
        fetch('/api/feishu/config')
        .then(response => response.json())
        .then(feishuData => {
            // 获取应用配置
            return fetch('/api/app-config')
            .then(response => response.json())
            .then(appConfigData => {
                if (feishuData.success) {
                    // 填充飞书配置信息
                    const appIdElement = document.getElementById('feishuAppId');
                    const appSecretElement = document.getElementById('feishuAppSecret');
                    
                    if (appIdElement) {
                        appIdElement.value = feishuData.config.app_id || '';
                    }
                    
                    if (appSecretElement) {
                        appSecretElement.value = ''; // 不返回secret
                    }
                    
                    // 填充自动同步配置
                    if (appConfigData.success) {
                        const autoSyncEnabled = appConfigData.config.feishu.auto_sync_enabled || false;
                        const autoSyncElement = document.getElementById('feishuAutoSync');
                        if (autoSyncElement) {
                            autoSyncElement.checked = autoSyncEnabled;
                        }
                    }
                    
                    // 显示模态框
                    const modal = document.getElementById('feishuConfigModal');
                    if (modal) {
                        modal.style.display = 'block';
                    }
                } else {
                    throw new Error(feishuData.error || '获取飞书配置失败');
                }
            });
        })
        .catch(error => {
            console.error('获取飞书配置失败:', error);
            alert('获取飞书配置失败: ' + error.message);
        });
    }
    
    function closeFeishuConfig() {
        const modal = document.getElementById('feishuConfigModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function saveFeishuConfig() {
        const appIdElement = document.getElementById('feishuAppId');
        const appSecretElement = document.getElementById('feishuAppSecret');
        const autoSyncElement = document.getElementById('feishuAutoSync');
        
        // 检查元素是否存在
        if (!appIdElement) {
            alert('找不到App ID输入元素');
            return;
        }
        
        const appId = appIdElement.value.trim();
        const appSecret = appSecretElement ? appSecretElement.value.trim() : '';
        const autoSyncEnabled = autoSyncElement ? autoSyncElement.checked : false;
        
        // 验证输入
        if (!appId) {
            alert('请输入App ID');
            return;
        }
        
        // 构造更新数据
        const updateData = {
            app_id: appId,
            app_secret: appSecret
        };
        
        // 显示同步进度
        document.getElementById('syncProgress').style.display = 'block';
        updateProgress(10, '正在保存飞书配置...');
        
        // 发送飞书配置更新请求
        fetch('/api/feishu/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(feishuData => {
            if (feishuData.success) {
                // 发送应用配置更新请求
                return fetch('/api/app-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        feishu: {
                            auto_sync_enabled: autoSyncEnabled
                        }
                    })
                })
                .then(response => response.json())
                .then(appConfigData => {
                    if (appConfigData.success) {
                        updateProgress(30, '飞书配置保存成功，开始同步数据...');
                        // 开始数据同步
                        startDataSync();
                    } else {
                        throw new Error(appConfigData.error || '保存应用配置失败');
                    }
                });
            } else {
                throw new Error(feishuData.error || '保存飞书配置失败');
            }
        })
        .catch(error => {
            console.error('保存飞书配置失败:', error);
            alert('保存飞书配置失败: ' + error.message);
            document.getElementById('syncProgress').style.display = 'none';
            closeFeishuConfig();
        });
    }
    
    function startDataSync() {
        // 关闭配置模态框
        closeFeishuConfig();
        
        // 更新进度
        updateProgress(40, '正在从飞书多维表格同步活动记录...');
        
        // 同步活动记录
        fetch('/api/init/sync-records', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgress(70, '活动记录同步完成，正在同步今日计划数据...');
                
                // 同步今日计划
                async function syncPlansFromFeishu() {
                    try {
                        showInitStatus('正在从飞书同步今日计划...', 'info');
                        
                        const response = await fetch('/api/feishu/sync-plans', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showInitStatus(`同步成功：${data.message}`, 'success');
                            // 延迟2秒后继续初始化流程
                            setTimeout(() => {
                                showStep(4);
                            }, 2000);
                        } else {
                            throw new Error(data.error || '从飞书同步今日计划失败');
                        }
                    } catch (error) {
                        console.error('从飞书同步今日计划失败:', error);
                        showInitStatus(`同步失败: ${error.message}`, 'error');
                    }
                }

                syncPlansFromFeishu();
            } else {
                throw new Error(data.error || '同步活动记录失败');
            }
        })
        .catch(error => {
            console.error('数据同步失败:', error);
            alert('数据同步失败: ' + error.message);
            document.getElementById('syncProgress').style.display = 'none';
        });
    }
    
    function updateProgress(percent, text) {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        if (progressFill) {
            progressFill.style.width = percent + '%';
        }
        
        if (progressText) {
            progressText.textContent = text;
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 添加模态框外部点击关闭功能
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('feishuConfigModal');
            if (event.target === modal) {
                closeFeishuConfig();
            }
        });
    });
</script>