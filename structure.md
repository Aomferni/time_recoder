# 时间记录器项目架构设计文档

## 1. 项目概述

时间记录器是一个基于Python Flask的时间追踪Web应用，帮助用户记录和管理日常活动时间。该应用采用模块化设计，将前端JavaScript代码拆分为多个独立的模块，以提高代码的可维护性和可扩展性。

## 2. 技术架构

### 2.1 后端架构
- **框架**: Python Flask
- **数据存储**: JSON文件存储（无需数据库）
- **API设计**: RESTful API
- **部署**: 独立运行，无需外部依赖

### 2.2 前端架构
- **HTML5**: 语义化标签和现代特性
- **CSS3**: 响应式设计和现代化样式
- **JavaScript**: 原生ES6模块化开发
- **AJAX**: 异步数据交互

### 2.3 时间处理架构
- **时间存储**: 使用UTC时间格式存储所有时间数据
- **时间显示**: 在前端界面显示时转换为北京时间
- **日期记录**: date字段记录北京时间的日期

## 3. 前端模块化设计

### 3.1 模块划分原则

前端代码按照功能职责划分为以下模块：

1. **JavaScript模块** - 按照功能职责划分为多个独立的模块
2. **CSS模块** - 按照功能和样式类型划分为多个独立的样式文件

### 3.2 JavaScript模块划分

前端JavaScript代码按照功能职责划分为以下模块：

1. **配置模块** (`config.js`) - 全局配置和状态管理
2. **工具模块** (`utils.js`) - 通用工具函数
3. **API模块** (`api.js`) - 后端接口调用
4. **UI模块** (`ui.js`) - 用户界面交互
5. **计时器模块** (`timer.js`) - 计时相关功能
6. **主模块** (`main.js`) - 应用初始化和协调

#### 3.2.1 JavaScript模块依赖关系

```
graph TD
    A[主模块 main.js] --> B[配置模块 config.js]
    A --> C[工具模块 utils.js]
    A --> D[API模块 api.js]
    A --> E[UI模块 ui.js]
    A --> F[计时器模块 timer.js]
    
    E --> B
    E --> C
    E --> D
    
    F --> B
    F --> C
    F --> D
    F --> E
    
    D --> B
```

#### 3.2.2 JavaScript各模块详细说明

##### 3.2.2.1 配置模块 (config.js)

**职责**: 管理应用的全局配置和状态变量

**包含内容**:
- 全局状态变量（当前活动、计时器状态等）
- 常量配置（活动类别映射、颜色映射等）
- 状态管理的setter函数

**导出接口**:
- 状态变量的getter
- 状态变量的setter函数

##### 3.2.2.2 工具模块 (utils.js)

**职责**: 提供通用的工具函数

**包含内容**:
- 时间格式化函数
- 持续时间计算函数
- CSS类名映射函数
- 情绪颜色处理函数

**导出接口**:
- `TimeRecorderFrontendUtils` 对象，包含所有工具函数

##### 3.2.2.3 API模块 (api.js)

**职责**: 封装所有与后端的HTTP通信

**包含内容**:
- 活动类别加载接口
- 用户名设置接口
- 记录增删改查接口
- 统计信息获取接口

**导出接口**:
- `TimeRecorderAPI` 对象，包含所有API调用函数

##### 3.2.2.4 UI模块 (ui.js)

**职责**: 处理所有用户界面相关的交互和更新

**包含内容**:
- 活动按钮渲染和更新
- 记录表格显示和更新
- 记录详情弹窗显示
- 用户交互事件处理

**导出接口**:
- `TimeRecorderUI` 对象，包含所有UI操作函数

##### 3.2.2.5 计时器模块 (timer.js)

**职责**: 处理计时相关的功能

**包含内容**:
- 计时器启动/停止逻辑
- 时间显示更新
- 记录创建和更新

**导出接口**:
- `TimeRecorderTimer` 对象，包含所有计时器相关函数

##### 3.2.2.6 主模块 (main.js)

**职责**: 应用初始化和模块协调

**包含内容**:
- DOM加载完成后的初始化逻辑
- 事件监听器绑定
- 模块间协调和全局状态管理

### 3.3 CSS模块划分

前端CSS样式按照功能和样式类型划分为以下模块：

1. **基础样式模块** (`base.css`) - 全局基础样式和动画
2. **用户区域模块** (`user-section.css`) - 用户信息区域样式
3. **布局模块** (`layout.css`) - 页面布局和板块样式
4. **活动按钮模块** (`activity-buttons.css`) - 活动按钮样式
5. **活动颜色模块** (`activity-colors.css`) - 活动分类颜色定义
6. **计时器模块** (`timer.css`) - 计时器区域样式
7. **控制按钮模块** (`control-buttons.css`) - 控制按钮样式
8. **详情模态框模块** (`detail-modal.css`) - 记录详情浮窗样式
9. **详情表单模块** (`detail-form.css`) - 记录详情表单样式
10. **导航模块** (`navigation.css`) - 导航链接样式
11. **记录表格模块** (`records-table.css`) - 记录表格样式
12. **统计模块** (`stats.css`) - 统计信息样式
13. **标签模块** (`labels.css`) - 分类和活动标签样式
14. **类别管理模块** (`manage-categories.css`) - 类别管理页面样式
15. **记录控制模块** (`records-controls.css`) - 记录筛选控制区域样式
16. **分页模块** (`pagination.css`) - 分页控件样式
17. **段落模块** (`segments.css`) - 段落信息样式
18. **记录详情模块** (`record-detail.css`) - 记录详情样式
19. **选中记录模块** (`selected-record.css`) - 选中记录样式
20. **详情分段模块** (`detail-sections.css`) - 详情页分段样式
21. **收获记录模块** (`remark.css`) - 收获记录区域样式
22. **活动类别模块** (`activity-category.css`) - 活动类别选择框样式
23. **开始时间模块** (`start-time.css`) - 开始时间输入框样式
24. **情绪标签模块** (`emotion-tag.css`) - 情绪标签样式
25. **控制按钮模块** (`control-btn.css`) - 控制按钮特殊样式

#### 3.3.1 CSS模块依赖关系

CSS模块采用扁平化结构，所有模块都直接依赖于基础样式模块，其他模块之间没有直接依赖关系。

```
graph TD
    A[基础样式 base.css] --> B[用户区域 user-section.css]
    A --> C[布局 layout.css]
    A --> D[活动按钮 activity-buttons.css]
    A --> E[活动颜色 activity-colors.css]
    A --> F[计时器 timer.css]
    A --> G[控制按钮 control-buttons.css]
    A --> H[详情模态框 detail-modal.css]
    A --> I[详情表单 detail-form.css]
    A --> J[导航 navigation.css]
    A --> K[记录表格 records-table.css]
    A --> L[统计 stats.css]
    A --> M[标签 labels.css]
    A --> N[类别管理 manage-categories.css]
    A --> O[记录控制 records-controls.css]
    A --> P[分页 pagination.css]
    A --> Q[段落 segments.css]
    A --> R[记录详情 record-detail.css]
    A --> S[选中记录 selected-record.css]
    A --> T[详情分段 detail-sections.css]
    A --> U[收获记录 remark.css]
    A --> V[活动类别 activity-category.css]
    A --> W[开始时间 start-time.css]
```

## 4. 功能模块设计

### 4.1 时间记录模块

#### 4.1.1 功能描述
实现时间记录的核心功能，包括活动选择、计时控制、记录保存等。

#### 4.1.2 核心逻辑
1. 用户选择活动类别和具体活动
2. 点击【开始】按钮启动计时器
3. 计时过程中实时更新显示时间
4. 点击【停止】按钮结束计时并保存记录
5. 支持暂停和继续功能

#### 4.1.3 数据结构
```json
{
  "id": "记录唯一标识符",
  "username": "用户名",
  "date": "记录日期（北京时间）",
  "activity": "活动名称",
  "activityCategory": "活动类别",
  "startTime": "开始时间（UTC）",
  "endTime": "结束时间（UTC）",
  "duration": "计时时长（毫秒）",
  "timeSpan": "时间跨度（毫秒）",
  "pauseCount": "暂停次数",
  "remark": "备注信息",
  "emotion": "情绪标签",
  "segments": [
    {
      "start": "段落开始时间（UTC）",
      "end": "段落结束时间（UTC）",
      "duration": "段落持续时间（毫秒）"
    }
  ]
}
```

### 4.2 情绪墙与活动类型墙模块

#### 4.2.1 功能描述
提供情绪和活动类型的可视化展示，帮助用户了解自己的时间分配和情绪变化。

#### 4.2.2 核心逻辑
1. 按日期展示情绪和活动类型数据
2. 使用颜色方块表示不同类型的情绪和活动
3. 支持点击方块查看详细记录
4. 提供关键词词云展示

#### 4.2.3 数据结构
```json
{
  "moodData": [
    {
      "name": "情绪名称",
      "color": "颜色值",
      "days": [
        {
          "date": "日期",
          "count": "出现次数"
        }
      ]
    }
  ],
  "activityData": [
    {
      "name": "活动类别",
      "color": "颜色值",
      "days": [
        {
          "date": "日期",
          "count": "出现次数"
        }
      ]
    }
  ]
}
```

### 4.3 数据导入导出模块

#### 4.3.1 功能描述
支持用户导入和导出时间记录数据，便于数据迁移和备份。

#### 4.3.2 核心逻辑
1. 支持JSON格式的数据导入
2. 提供数据导出功能
3. 实现数据验证和错误处理
4. 支持多用户数据管理

## 5. 版本更新记录

### v1.1 (2025-10-13)
- 更新项目说明文档
- 更新版本号为V1.1
- 更新项目结构说明

### v1.0.60 (2025-10-13)
- 优化按钮整体布局
  - 调整【开始】和【停止】按钮尺寸，避免过大导致遮盖
  - 为各主要区域添加明确的z-index层级关系
  - 增加元素间的间距和空间
  - 确保导航链接不会被其他元素遮盖

### v1.0.59 (2025-10-13)
- 修复记录详情加载失败问题
  - 修复直接调用formatDateTimeForInput函数导致的ReferenceError错误
  - 统一使用TimeRecorderFrontendUtils.formatDateTimeForInput工具函数
  - 确保记录详情页面能正常加载和显示

### v1.0.58 (2025-10-13)
- 优化主页按钮布局
  - 保持【开始】按钮字体放大到三倍（54px）
  - 优化按钮视觉效果，添加悬停和点击反馈
  - 增强按钮阴影和动画效果
  - 确保开始按钮和停止按钮视觉一致性

### v1.0.57 (2025-10-13)
- 修复未选择活动时点击开始按钮的提醒问题
  - 完善活动选择检查逻辑，确保在未选择活动时点击【开始】按钮会弹窗提醒
  - 增加对默认"请选择活动"文本的检查
  - 提升用户体验，避免无效操作

### v1.0.56 (2025-10-13)
- 修复活动详情页计时时长显示问题
  - 重新计算段落总时间以确保计时时长显示准确
  - 优先使用重新计算的段落总时间，只有在无法计算时才使用record.duration作为后备值
  - 确保活动详情页显示的计时时长与实际段落总时间一致

### v1.0.55 (2025-10-13)
- 修复活动详情浮窗默认显示问题
  - 为主页和历史记录页面的活动详情浮窗添加默认隐藏样式
  - 确保刷新页面时浮窗默认隐藏，只在用户点击相关元素时显示
  - 统一所有页面的活动详情浮窗行为

### v1.0.54 (2025-10-13)
- 修复活动详情查找问题
  - 修正活动详情查找的匹配逻辑，增加调试日志和宽松搜索机制

### v1.0.53 (2025-10-13)
- 修复导航元素查找问题
  - 解决"找不到.navigation元素"的JavaScript错误，更新UI模块中导航元素的查找目标

### v1.0.52 (2025-10-13)
- 修复活动按钮插入错误
  - 解决"Failed to execute 'insertBefore' on 'Node'"的JavaScript错误，更新UI模块中活动按钮的插入逻辑

### v1.0.51 (2025-10-13)
- 修复记录详情加载失败问题
  - 解决"ReferenceError: totalDuration is not defined"错误，确保记录详情页面正常显示

### v1.0.50 (2025-10-13)
- 修复记录结束时间问题
  - 确保记录的endTime始终是最后一个段落的结束时间

### v1.0.49 (2025-10-13)
- 修复活动类型墙出现【其他】类型问题
  - 解决活动名称与类别配置不匹配导致的【其他】类型问题，实现宽松匹配机制，提高活动类别匹配准确率

### v1.0.48 (2025-10-13)
- 优化活动详情页布局
  - 将记录情绪放在记录收获的下方，缩小其他信息的字体，支持左右扩展模态框

### v1.0.47 (2025-10-13)
- 整体页面布局优化
  - 优化管理类别页面布局和样式，统一各页面布局风格，改善响应式设计，提升用户交互体验

### v1.0.46 (2025-10-13)
- 段落按开始时间排序
  - 段落按照start排序，开始时间为第一个段落的start

### v1.0.45 (2025-10-13)
- 新增导入记录文件功能
  - 支持导入用户的record.json文件

### v1.0.44 (2025-10-13)
- 情绪墙和活动类型墙支持打开记录详情并缩小方块
  - 情绪墙中的情绪方块支持打开记录详情，缩小活动类型墙和情绪墙的方块尺寸

### v1.0.43 (2025-10-13)
- 修复活动详情查找问题
  - 修正活动详情查找的匹配逻辑，增加调试日志和宽松搜索机制

### v1.0.42 (2025-10-13)
- 修复导航元素查找问题
  - 解决"找不到.navigation元素"的JavaScript错误，更新UI模块中导航元素的查找目标

### v1.0.41 (2025-10-13)
- 修复活动按钮插入错误
  - 解决"Failed to execute 'insertBefore' on 'Node'"的JavaScript错误，更新UI模块中活动按钮的插入逻辑

### v1.0.40 (2025-10-13)
- 修复记录详情加载失败问题
  - 解决"ReferenceError: totalDuration is not defined"错误，确保记录详情页面正常显示

### v1.0.39 (2025-10-13)
- 修复记录结束时间问题
  - 确保记录的endTime始终是最后一个段落的结束时间

### v1.0.38 (2025-10-13)
- 修复活动类型墙出现【其他】类型问题
  - 解决活动名称与类别配置不匹配导致的【其他】类型问题，实现宽松匹配机制，提高活动类别匹配准确率

### v1.0.37 (2025-10-13)
- 优化活动详情页布局
  - 将记录情绪放在记录收获的下方，缩小其他信息的字体，支持左右扩展模态框

### v1.0.36 (2025-10-13)
- 整体页面布局优化
  - 优化管理类别页面布局和样式，统一各页面布局风格，改善响应式设计，提升用户交互体验

### v1.0.35 (2025-10-13)
- 段落按开始时间排序
  - 段落按照start排序，开始时间为第一个段落的start

### v1.0.34 (2025-10-13)
- 新增导入记录文件功能
  - 支持导入用户的record.json文件

### v1.0.33 (2025-10-13)
- 情绪墙和活动类型墙支持打开记录详情并缩小方块
  - 情绪墙中的情绪方块支持打开记录详情，缩小活动类型墙和情绪墙的方块尺寸

### v1.0.32 (2025-10-13)
- 修复活动详情查找问题
  - 修正活动详情查找的匹配逻辑，增加调试日志和宽松搜索机制

### v1.0.31 (2025-10-13)
- 修复导航元素查找问题
  - 解决"找不到.navigation元素"的JavaScript错误，更新UI模块中导航元素的查找目标

### v1.0.30 (2025-10-13)
- 修复活动按钮插入错误
  - 解决"Failed to execute 'insertBefore' on 'Node'"的JavaScript错误，更新UI模块中活动按钮的插入逻辑

### v1.0.29 (2025-10-13)
- 修复记录详情加载失败问题
  - 解决"ReferenceError: totalDuration is not defined"错误，确保记录详情页面正常显示

### v1.0.28 (2025-10-13)
- 修复记录结束时间问题
  - 确保记录的endTime始终是最后一个段落的结束时间

### v1.0.27 (2025-10-13)
- 修复活动类型墙出现【其他】类型问题
  - 解决活动名称与类别配置不匹配导致的【其他】类型问题，实现宽松匹配机制，提高活动类别匹配准确率

### v1.0.26 (2025-10-13)
- 优化活动详情页布局
  - 将记录情绪放在记录收获的下方，缩小其他信息的字体，支持左右扩展模态框

### v1.0.25 (2025-10-13)
- 整体页面布局优化
  - 优化管理类别页面布局和样式，统一各页面布局风格，改善响应式设计，提升用户交互体验

### v1.0.24 (2025-10-13)
- 段落按开始时间排序
  - 段落按照start排序，开始时间为第一个段落的start

### v1.0.23 (2025-10-13)
- 新增导入记录文件功能
  - 支持导入用户的record.json文件

### v1.0.22 (2025-10-13)
- 情绪墙和活动类型墙支持打开记录详情并缩小方块
  - 情绪墙中的情绪方块支持打开记录详情，缩小活动类型墙和情绪墙的方块尺寸

### v1.0.21 (2025-10-13)
- 修复活动详情查找问题
  - 修正活动详情查找的匹配逻辑，增加调试日志和宽松搜索机制

### v1.0.20 (2025-10-13)
- 修复导航元素查找问题
  - 解决"找不到.navigation元素"的JavaScript错误，更新UI模块中导航元素的查找目标

### v1.0.19 (2025-10-13)
- 修复活动按钮插入错误
  - 解决"Failed to execute 'insertBefore' on 'Node'"的JavaScript错误，更新UI模块中活动按钮的插入逻辑

### v1.0.18 (2025-10-13)
- 修复记录详情加载失败问题
  - 解决"ReferenceError: totalDuration is not defined"错误，确保记录详情页面正常显示

### v1.0.17 (2025-10-13)
- 修复记录结束时间问题
  - 确保记录的endTime始终是最后一个段落的结束时间

### v1.0.16 (2025-10-13)
- 修复活动类型墙出现【其他】类型问题
  - 解决活动名称与类别配置不匹配导致的【其他】类型问题，实现宽松匹配机制，提高活动类别匹配准确率

### v1.0.15 (2025-10-13)
- 优化活动详情页布局
  - 将记录情绪放在记录收获的下方，缩小其他信息的字体，支持左右扩展模态框

### v1.0.14 (2025-10-13)
- 整体页面布局优化
  - 优化管理类别页面布局和样式，统一各页面布局风格，改善响应式设计，提升用户交互体验

### v1.0.13 (2025-10-13)
- 段落按开始时间排序
  - 段落按照start排序，开始时间为第一个段落的start

### v1.0.12 (2025-10-13)
- 新增导入记录文件功能
  - 支持导入用户的record.json文件

### v1.0.11 (2025-10-13)
- 情绪墙和活动类型墙支持打开记录详情并缩小方块
  - 情绪墙中的情绪方块支持打开记录详情，缩小活动类型墙和情绪墙的方块尺寸

### v1.0.10 (2025-10-13)
- 修复活动详情查找问题
  - 修正活动详情查找的匹配逻辑，增加调试日志和宽松搜索机制

### v1.0.9 (2025-10-13)
- 修复导航元素查找问题
  - 解决"找不到.navigation元素"的JavaScript错误，更新UI模块中导航元素的查找目标

### v1.0.8 (2025-10-13)
- 修复活动按钮插入错误
  - 解决"Failed to execute 'insertBefore' on 'Node'"的JavaScript错误，更新UI模块中活动按钮的插入逻辑

### v1.0.7 (2025-10-13)
- 修复记录详情加载失败问题
  - 解决"ReferenceError: totalDuration is not defined"错误，确保记录详情页面正常显示

### v1.0.6 (2025-10-13)
- 修复记录结束时间问题
  - 确保记录的endTime始终是最后一个段落的结束时间

### v1.0.5 (2025-10-13)
- 修复活动类型墙出现【其他】类型问题
  - 解决活动名称与类别配置不匹配导致的【其他】类型问题，实现宽松匹配机制，提高活动类别匹配准确率

### v1.0.4 (2025-10-13)
- 优化活动详情页布局
  - 将记录情绪放在记录收获的下方，缩小其他信息的字体，支持左右扩展模态框

### v1.0.3 (2025-10-13)
- 整体页面布局优化
  - 优化管理类别页面布局和样式，统一各页面布局风格，改善响应式设计，提升用户交互体验

### v1.0.2 (2025-10-13)
- 段落按开始时间排序
  - 段落按照start排序，开始时间为第一个段落的start

### v1.0.65 (2025-10-13)
- 去除导入记录按钮周边方框
  - 移除导入记录按钮周围的容器框
  - 使导入记录按钮与其他操作按钮保持一致的布局

### v1.0.64 (2025-10-13)
- 统一历史记录页按钮样式
  - 统一搜索、重置、导出记录、导入记录四个按钮的样式
  - 使四个按钮具有一致的外观和交互效果

### v1.0.63 (2025-10-13)
- 移动导入记录按钮到历史记录页
  - 将导入记录按钮从主页移动到历史记录页面
  - 放置在导出记录按钮的右侧
  - 保持导入功能与之前一致

### v1.0.62 (2025-10-13)
- 新增记录文件导出功能
  - 支持导出当前用户的记录文件为JSON格式
  - 仅能导出当前登录用户的记录，确保数据安全性
  - 在历史记录页面添加导出按钮

### v1.0.61 (2025-10-13)
- 修复计时时长没有累加所有segment时长问题
  - 修改records.html模板中的记录详情显示逻辑，重新计算所有段落的总时间
  - 修改ui.js模块中的记录详情显示逻辑，重新计算所有段落的总时间
  - 修改utils.js模块中的calculateRecordTotalTime函数，确保正确计算所有段落的时间

### v1.0.1 (2025-10-13)
- 新增导入记录文件功能
  - 支持导入用户的record.json文件

### v1.0.0 (2025-10-13)
- 项目初始版本
- 实现时间记录的核心功能
- 提供情绪和活动类型的可视化展示
- 支持用户导入和导出时间记录数据
