# 时间记录器项目架构设计文档

## 1. 项目概述

时间记录器是一个基于Python Flask的时间追踪Web应用，帮助用户记录和管理日常活动时间。该应用采用模块化设计，将前端JavaScript代码拆分为多个独立的模块，以提高代码的可维护性和可扩展性。

## 2. 技术架构

### 2.1 后端架构
- **框架**: Python Flask
- **数据存储**: JSON文件存储（无需数据库）
- **API设计**: RESTful API
- **部署**: 独立运行，无需外部依赖

### 2.2 前端架构
- **HTML5**: 语义化标签和现代特性
- **CSS3**: 响应式设计和现代化样式
- **JavaScript**: 原生ES6模块化开发
- **AJAX**: 异步数据交互

### 2.3 时间处理架构
- **时间存储**: 使用UTC时间格式存储所有时间数据
- **时间显示**: 在前端界面显示时转换为北京时间
- **日期记录**: date字段记录北京时间的日期

## 3. 前端模块化设计

### 3.1 模块划分原则

前端代码按照功能职责划分为以下模块：

1. **JavaScript模块** - 按照功能职责划分为多个独立的模块
2. **CSS模块** - 按照功能和样式类型划分为多个独立的样式文件

### 3.2 JavaScript模块划分

前端JavaScript代码按照功能职责划分为以下模块：

1. **配置模块** (`config.js`) - 全局配置和状态管理
2. **工具模块** (`utils.js`) - 通用工具函数
3. **API模块** (`api.js`) - 后端接口调用
4. **UI模块** (`ui.js`) - 用户界面交互
5. **计时器模块** (`timer.js`) - 计时相关功能
6. **记录详情模块** (`recordDetail.js`) - 统一记录详情显示和编辑
7. **记录列表模块** (`records.js`) - 记录列表管理
8. **飞书配置模块** (`feishuConfig.js`) - 飞书配置管理（v1.2.10新增）
9. **今日计划模块** (`dailyPlan.js`) - 今日计划管理（v1.2.12优化）
10. **主模块** (`main.js`) - 应用初始化和协调

#### 3.2.1 JavaScript模块依赖关系

```
graph TD
    A[主模块 main.js] --> B[配置模块 config.js]
    A --> C[工具模块 utils.js]
    A --> D[API模块 api.js]
    A --> E[UI模块 ui.js]
    A --> F[计时器模块 timer.js]
    A --> G[记录详情模块 recordDetail.js]
    A --> H[记录列表模块 records.js]
    A --> I[飞书配置模块 feishuConfig.js]
    A --> J[今日计划模块 dailyPlan.js]
    
    E --> B
    E --> C
    E --> D
    E --> G
    
    F --> B
    F --> C
    F --> D
    F --> E
    F --> G
    
    D --> B
    
    G --> B
    G --> C
    G --> D
    
    H --> B
    H --> C
    H --> D
    H --> G
    H --> I
    
    C --> B
    
    I --> B
    
    J --> B
    J --> C
    J --> D
    J --> I
```

#### 3.2.2 JavaScript各模块详细说明

##### 3.2.2.1 配置模块 (config.js)

**职责**: 管理应用的全局配置和状态变量

**包含内容**:
- 全局状态变量（当前活动、计时器状态等）
- 常量配置（活动类别映射、颜色映映射等）
- 状态管理的setter函数

**导出接口**:
- 状态变量的getter
- 状态变量的setter函数

##### 3.2.2.2 工具模块 (utils.js)

**职责**: 提供通用的工具函数

**包含内容**:
- 时间格式化函数
- 持续时间计算函数
- CSS类名映射函数
- 情绪颜色处理函数
- 时间字符串解析函数
- 情绪emoji获取函数（v1.2.12新增）

**导出接口**:
- `TimeRecorderFrontendUtils` 对象，包含所有工具函数

##### 3.2.2.3 API模块 (api.js)

**职责**: 封装所有与后端的HTTP通信

**包含内容**:
- 活动类别加载接口
- 用户名设置接口
- 记录增删改查接口
- 统计信息获取接口
- 所有记录加载接口（带筛选和分页）
- 情绪墙和活动墙数据接口

**导出接口**:
- `TimeRecorderAPI` 对象，包含所有API调用函数

##### 3.2.2.4 UI模块 (ui.js)

#### 3.2.2.4.1 职责
处理所有用户界面相关的交互和更新

#### 3.2.2.4.2 包含内容
- 活动按钮渲染和更新
- 记录表格显示和更新
- 记录详情弹窗显示
- 用户交互事件处理

#### 3.2.2.4.3 核心逻辑
1. 活动按钮渲染逻辑
   - 查找包含"选择活动"标题的特定section元素
   - 根据活动类别配置动态生成活动按钮
   - 将活动按钮渲染到正确的位置
2. 记录表格更新逻辑
   - 动态生成今日记录表格
   - 处理记录选中状态
3. 模态框控制逻辑
   - 控制记录详情浮窗的显示和隐藏

#### 3.2.2.4.4 导出接口
- `TimeRecorderUI` 对象，包含所有UI操作函数

##### 3.2.2.5 计时器模块 (timer.js)

**职责**: 处理计时相关的功能

**包含内容**:
- 计时器启动/停止逻辑
- 时间显示更新
- 记录创建和更新

**导出接口**:
- `TimeRecorderTimer` 对象，包含所有计时器相关函数

##### 3.2.2.6 记录详情模块 (recordDetail.js)

**职责**: 统一处理所有页面的记录详情显示和编辑功能

**包含内容**:
- 记录详情显示（简化版和完整版）
- 记录编辑和保存功能
- 段落管理功能
- 统一的模态框控制
- 情绪选择交互优化（v1.2.12优化）

**导出接口**:
- `TimeRecorderRecordDetail` 对象，包含所有记录详情操作函数

##### 3.2.2.7 记录列表模块 (records.js)

**职责**: 处理记录列表页面的相关功能

**包含内容**:
- 记录列表显示和筛选
- 分页功能
- 记录详情显示
- 数据导出功能

**导出接口**:
- `TimeRecorderRecords` 对象，包含所有记录列表操作函数

##### 3.2.2.8 飞书配置模块 (feishuConfig.js)（v1.2.10新增）

**职责**: 统一管理飞书配置的显示、保存和关闭功能

**包含内容**:
- 飞书配置模态框显示和关闭
- 飞书配置保存
- 从飞书导入信息功能（v1.2.12优化）

**导出接口**:
- `FeishuConfigModule` 对象，包含所有飞书配置操作函数

##### 3.2.2.9 今日计划模块 (dailyPlan.js)（v1.2.12新增）

**职责**: 处理今日计划相关的功能

**包含内容**:
- 今日计划加载和保存
- 今日计划自动保存（每小时）
- 今日计划同步到飞书功能
- 今日计划UI交互优化

**导出接口**:
- `DailyPlanModule` 对象，包含所有今日计划操作函数

##### 3.2.2.10 主模块 (main.js)

**职责**: 应用初始化和协调各模块工作

**包含内容**:
- 应用初始化
- 模块间协调
- 全局事件处理

**导出接口**:
- 应用初始化函数

## 4. CSS模块化设计

### 4.1 模块划分原则

CSS代码按照功能和样式类型划分为多个独立的样式文件，便于维护和扩展。

### 4.2 CSS模块列表

1. **基础样式** (`base.css`) - 全局基础样式
2. **布局样式** (`layout.css`) - 页面布局相关样式
3. **活动按钮样式** (`activity-buttons.css`) - 活动按钮样式
4. **活动颜色样式** (`activity-colors.css`) - 活动分类颜色定义
5. **计时器样式** (`timer.css`) - 计时器区域样式（v1.2.12优化）
6. **控制按钮样式** (`control-buttons.css`) - 控制按钮样式
7. **详情模态框样式** (`detail-modal.css`) - 模态框样式（v1.2.12优化）
8. **详情表单样式** (`detail-form.css`) - 详情表单样式
9. **导航样式** (`navigation.css`) - 导航链接样式
10. **记录表格样式** (`records-table.css`) - 记录表格样式
11. **统计信息样式** (`stats.css`) - 统计信息样式
12. **标签样式** (`labels.css`) - 标签样式
13. **类别管理样式** (`manage-categories.css`) - 类别管理页面样式
14. **记录控制样式** (`records-controls.css`) - 记录控制区域样式
15. **分页样式** (`pagination.css`) - 分页控件样式
16. **段落样式** (`segments.css`) - 段落相关样式
17. **选中记录样式** (`selected-record.css`) - 选中记录样式
18. **备注样式** (`remark.css`) - 备注区域样式
19. **活动类别样式** (`activity-category.css`) - 活动类别样式
20. **情绪标签样式** (`emotion-tag.css`) - 情绪标签样式
21. **控制按钮样式** (`control-btn.css`) - 控制按钮样式
22. **情绪墙样式** (`mood-wall.css`) - 情绪墙样式
23. **飞书导入样式** (`feishu-import.css`) - 飞书导入样式
24. **飞书配置样式** (`feishu-config.css`) - 飞书配置样式
25. **顶部导航样式** (`top-navigation.css`) - 顶部导航样式（v1.2.12优化）
26. **用户区域样式** (`user-section.css`) - 用户区域样式
27. **每日计划样式** (`daily-plan.css`) - 每日计划样式（v1.2.12优化）
28. **详情区域样式** (`detail-sections.css`) - 详情区域样式
29. **活动选择优化样式** (`activity-selection-optimized.css`) - 活动选择弹窗优化样式（v1.2.12新增）

### 4.3 样式优化记录

#### 4.3.1 计时器样式优化（v1.2.12）
- 优化了计时器区域的视觉效果
- 改进了计时器运行时的样式反馈

#### 4.3.2 活动选择弹窗优化（v1.2.12）
- 创建了 `activity-selection-optimized.css` 文件
- 实现了每行最多显示8个按钮的网格布局
- 保持了按活动类别分组显示的结构
- 优化了按钮的悬停效果和交互动画

#### 4.3.3 顶部导航样式优化（v1.2.12）
- 创建了 `navigation-optimized.css` 文件
- 采用与项目原始风格一致的设计
- 统一了各页面的导航样式

#### 4.3.4 每日计划样式优化（v1.2.12）
- 优化了每日计划区域的视觉效果
- 改进了折叠/展开交互体验

## 5. 数据流逻辑

### 5.1 核心数据流

#### 5.1.1 活动记录数据流
```
用户选择活动
    ↓
创建活动记录
    ↓
开始计时
    ↓
暂停/继续操作创建段落
    ↓
停止计时
    ↓
保存记录到本地JSON文件
    ↓
可选：同步到飞书多维表格
```

#### 5.1.2 今日计划数据流
```
用户填写今日计划
    ↓
自动保存到本地JSON文件（每小时）
    ↓
可选：同步到飞书多维表格
    ↓
次日自动加载新日期的计划
```

#### 5.1.3 飞书数据同步数据流
```
用户配置飞书集成
    ↓
验证飞书链接有效性
    ↓
从飞书导入数据（活动记录和今日计划）
    ↓
保存到本地JSON文件
    ↓
应用正常启动并显示同步数据
```

#### 5.1.4 飞书数据导入数据流（v1.2.13优化）
```
用户点击【从飞书导入】按钮
    ↓
调用 [/api/init/sync-records](file:///Users/amy/Documents/codes/time_recoder/app.py#L1372-L1511) 接口同步活动记录
    ↓
调用 [/api/feishu/sync-plans](file:///Users/amy/Documents/codes/time_recoder/app.py#L1500-L1568) 接口同步今日计划
    ↓
保存到本地JSON文件（records.json和plans.json）
    ↓
刷新页面显示导入的数据
```

### 5.2 数据结构

#### 5.2.1 活动记录结构
```json
{
  "id": "记录唯一标识符",
  "date": "记录日期 (YYYY/MM/DD)",
  "activity": "活动名称",
  "activityCategory": "活动类别",
  "startTime": "开始时间 (ISO 8601格式)",
  "endTime": "结束时间 (ISO 8601格式)",
  "duration": "专注时长 (毫秒)",
  "timeSpan": "时间跨度 (毫秒)",
  "pauseCount": "暂停次数",
  "remark": "备注信息",
  "emotion": "情绪记录 (逗号分隔的字符串)",
  "segments": [
    {
      "start": "段落开始时间 (ISO 8601格式)",
      "end": "段落结束时间 (ISO 8601格式)"
    }
  ]
}
```

#### 5.2.2 今日计划结构
``json
{
  "date": "计划日期 (YYYY-MM-DD)",
  "importantThings": ["重要事项1", "重要事项2", "重要事项3"],
  "tryThings": ["尝试事项1", "尝试事项2", "尝试事项3"],
  "otherMatters": "其他事项",
  "reading": "阅读计划",
  "score": "今日评分",
  "scoreReason": "评分原因",
  "totalDuration": "专注时长",
  "creationDuration": "创作时长",
  "activityCount": "活动次数",
  "activities": ["活动1", "活动2"],
  "emotions": ["情绪1", "情绪2"],
  "activityCategories": ["类别1", "类别2"],
  "lastSyncTime": "最后同步时间",
  "feishuRecordId": "飞书记录ID"
}
```

**飞书字段映射说明**：
- `importantThings` 对应飞书多维表格中的 "今天重要的三件事" 字段
- `tryThings` 对应飞书多维表格中的 "今天要尝试的三件事" 字段
- `score` 对应飞书多维表格中的 "给今天打个分" 字段
- `scoreReason` 对应飞书多维表格中的 "为什么？" 字段

## 6. 飞书集成架构

### 6.1 飞书配置管理
- 通过 `/api/feishu/config` 接口管理飞书配置
- 支持App ID和App Secret的配置和持久化

### 6.2 数据同步机制
- 支持活动记录和今日计划的双向同步
- 自动同步机制（今日计划每小时自动同步）
- 手动同步机制（通过飞书配置页面触发）
- **支持通过【从飞书导入】按钮一次性同步活动记录和今日计划**

### 6.3 错误处理
- 网络错误重试机制
- 飞书API错误处理
- 数据格式验证

## 7. 版本更新记录

### v1.2.15 (2025-10-19)
- **功能修复**：
  - 修复飞书导入今日计划功能，确保能正确同步plans.json文件
  - 完善从飞书多维表格获取今日计划数据并保存到本地的实现
  - 增强错误处理和日志记录

### v1.2.14 (2025-10-19)
- **代码优化**：
  - 合并了 `init_sync_plans_from_feishu` 和 `sync_plans_from_feishu` 函数，避免代码重复
  - 统一了飞书同步今日计划的API端点为 `/api/feishu/sync-plans`
  - 更新了前端调用以使用统一的API端点

### v1.2.13 (2025-10-19)
- **优化功能**：
  - 优化文档描述，明确飞书数据导入包含活动记录和今日计划的同步
  - 优化飞书集成架构描述

### v1.2.12 (2025-10-19)
- **新增功能**：
  - 支持从飞书配置页面手动触发数据导入功能
- **优化功能**：
  - 优化活动选择弹窗布局，每行最多显示8个按钮
  - 优化顶部导航栏样式，统一各页面导航样式
  - 优化计时器区域视觉效果
  - 优化每日计划区域交互体验
- **修复问题**：
  - 修复飞书导入功能未能从指定表格导入所有记录的问题
  - 修复活动详情页情绪按钮显示emoji的问题

### v1.2.11 (2025-10-18)
- **新增功能**：
  - 增加飞书配置模块，统一管理飞书集成配置
  - 增加初始化配置功能，支持首次使用时配置飞书集成
- **优化功能**：
  - 优化记录详情页情绪选择交互
  - 优化移动端适配

### v1.2.10 (2025-10-17)
- **新增功能**：
  - 增加飞书多维表格集成，支持数据同步
  - 增加今日计划自动同步功能
- **优化功能**：
  - 优化情绪墙和活动墙显示效果
  - 优化记录详情页显示效果

### v1.2.9 (2025-10-16)
- **优化功能**：
  - 优化活动选择弹窗布局
  - 优化计时器交互体验
  - 优化移动端适配

### v1.2.8 (2025-10-15)
- **新增功能**：
  - 增加情绪记录功能
  - 增加情绪墙和活动墙可视化展示
- **优化功能**：
  - 优化记录详情页显示效果
  - 优化数据统计功能

### v1.2.7 (2025-10-14)
- **新增功能**：
  - 增加今日计划功能
  - 增加数据统计功能
- **优化功能**：
  - 优化记录管理功能
  - 优化界面交互体验

### v1.2.6 (2025-10-13)
- **新增功能**：
  - 增加活动分类管理功能
  - 增加记录详情编辑功能
- **优化功能**：
  - 优化计时器功能
  - 优化界面显示效果

### v1.2.5 (2025-10-12)
- **初始版本**：
  - 实现基本的时间记录功能
  - 实现活动选择和计时功能
  - 实现记录查看和管理功能