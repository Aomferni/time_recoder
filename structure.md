# 时间记录器项目架构设计文档

## 1. 项目概述

时间记录器是一个基于Python Flask的时间追踪Web应用，帮助用户记录和管理日常活动时间。该应用采用模块化设计，将前端JavaScript代码拆分为多个独立的模块，以提高代码的可维护性和可扩展性。

## 2. 技术架构

### 2.1 后端架构
- **框架**: Python Flask
- **数据存储**: JSON文件存储（无需数据库）
- **API设计**: RESTful API
- **部署**: 独立运行，无需外部依赖

### 2.2 前端架构
- **HTML5**: 语义化标签和现代特性
- **CSS3**: 响应式设计和现代化样式
- **JavaScript**: 原生ES6模块化开发
- **AJAX**: 异步数据交互

### 2.3 时间处理架构
- **时间存储**: 使用UTC时间格式存储所有时间数据
- **时间显示**: 在前端界面显示时转换为北京时间
- **日期记录**: date字段记录北京时间的日期

## 3. 前端模块化设计

### 3.1 模块划分原则

前端代码按照功能职责划分为以下模块：

1. **JavaScript模块** - 按照功能职责划分为多个独立的模块
2. **CSS模块** - 按照功能和样式类型划分为多个独立的样式文件

### 3.2 JavaScript模块划分

前端JavaScript代码按照功能职责划分为以下模块：

1. **配置模块** (`config.js`) - 全局配置和状态管理
2. **工具模块** (`utils.js`) - 通用工具函数
3. **API模块** (`api.js`) - 后端接口调用
4. **UI模块** (`ui.js`) - 用户界面交互
5. **计时器模块** (`timer.js`) - 计时相关功能
6. **记录详情模块** (`recordDetail.js`) - 统一记录详情显示和编辑
7. **记录列表模块** (`records.js`) - 记录列表管理
8. **飞书配置模块** (`feishuConfig.js`) - 飞书配置管理（v1.2.10新增）
9. **主模块** (`main.js`) - 应用初始化和协调

#### 3.2.1 JavaScript模块依赖关系

```
graph TD
    A[主模块 main.js] --> B[配置模块 config.js]
    A --> C[工具模块 utils.js]
    A --> D[API模块 api.js]
    A --> E[UI模块 ui.js]
    A --> F[计时器模块 timer.js]
    A --> G[记录详情模块 recordDetail.js]
    A --> H[记录列表模块 records.js]
    A --> I[飞书配置模块 feishuConfig.js]
    
    E --> B
    E --> C
    E --> D
    E --> G
    
    F --> B
    F --> C
    F --> D
    F --> E
    F --> G
    
    D --> B
    
    G --> B
    G --> C
    G --> D
    
    H --> B
    H --> C
    H --> D
    H --> G
    H --> I
    
    C --> B
    
    I --> B
```

#### 3.2.2 JavaScript各模块详细说明

##### 3.2.2.1 配置模块 (config.js)

**职责**: 管理应用的全局配置和状态变量

**包含内容**:
- 全局状态变量（当前活动、计时器状态等）
- 常量配置（活动类别映射、颜色映映射等）
- 状态管理的setter函数

**导出接口**:
- 状态变量的getter
- 状态变量的setter函数

##### 3.2.2.2 工具模块 (utils.js)

**职责**: 提供通用的工具函数

**包含内容**:
- 时间格式化函数
- 持续时间计算函数
- CSS类名映射函数
- 情绪颜色处理函数
- 时间字符串解析函数

**导出接口**:
- `TimeRecorderFrontendUtils` 对象，包含所有工具函数

##### 3.2.2.3 API模块 (api.js)

**职责**: 封装所有与后端的HTTP通信

**包含内容**:
- 活动类别加载接口
- 用户名设置接口
- 记录增删改查接口
- 统计信息获取接口
- 所有记录加载接口（带筛选和分页）
- 情绪墙和活动墙数据接口

**导出接口**:
- `TimeRecorderAPI` 对象，包含所有API调用函数

##### 3.2.2.4 UI模块 (ui.js)

#### 3.2.2.4.1 职责
处理所有用户界面相关的交互和更新

#### 3.2.2.4.2 包含内容
- 活动按钮渲染和更新
- 记录表格显示和更新
- 记录详情弹窗显示
- 用户交互事件处理

#### 3.2.2.4.3 核心逻辑
1. 活动按钮渲染逻辑
   - 查找包含"选择活动"标题的特定section元素
   - 根据活动类别配置动态生成活动按钮
   - 将活动按钮渲染到正确的位置
2. 记录表格更新逻辑
   - 动态生成今日记录表格
   - 处理记录选中状态
3. 模态框控制逻辑
   - 控制记录详情浮窗的显示和隐藏

#### 3.2.2.4.4 导出接口
- `TimeRecorderUI` 对象，包含所有UI操作函数

##### 3.2.2.5 计时器模块 (timer.js)

**职责**: 处理计时相关的功能

**包含内容**:
- 计时器启动/停止逻辑
- 时间显示更新
- 记录创建和更新

**导出接口**:
- `TimeRecorderTimer` 对象，包含所有计时器相关函数

##### 3.2.2.6 记录详情模块 (recordDetail.js)

**职责**: 统一处理所有页面的记录详情显示和编辑功能

**包含内容**:
- 记录详情显示（简化版和完整版）
- 记录编辑和保存功能
- 段落管理功能
- 统一的模态框控制
- 情绪选择交互优化

**导出接口**:
- `TimeRecorderRecordDetail` 对象，包含所有记录详情操作函数

##### 3.2.2.7 记录列表模块 (records.js)

**职责**: 处理记录列表页面的相关功能

**包含内容**:
- 记录列表显示和筛选
- 分页功能
- 记录详情显示
- 数据导出功能

**导出接口**:
- `TimeRecorderRecords` 对象，包含所有记录列表操作函数

##### 3.2.2.8 飞书配置模块 (feishuConfig.js)（v1.2.10新增）

**职责**: 统一管理飞书配置的显示、保存和关闭功能

**包含内容**:
- 飞书配置模态框显示逻辑
- 飞书配置保存逻辑
- 飞书配置模态框关闭逻辑

**核心逻辑**:
1. **显示配置**:
   - 调用GET `/api/feishu/config`获取当前配置
   - 填充App ID到输入框（App Secret不返回）
   - 显示飞书配置模态框

2. **保存配置**:
   - 验证App ID是否为空
   - 构造更新数据（只包含填写的字段）
   - 调用POST `/api/feishu/config`保存配置
   - 保存成功后关闭模态框并显示提示

3. **关闭配置**:
   - 点击关闭按钮关闭模态框
   - 点击模态框外部区域关闭模态框

**导出接口**:
- `FeishuConfigModule` 对象，包含所有飞书配置操作函数
- 向后兼容的全局函数：`window.showFeishuConfig`、`window.closeFeishuConfig`、`window.saveFeishuConfig`

**设计优势**:
- **单一职责**: 飞书配置功能集中在一个模块
- **代码复用**: 主页和历史记录页面共用同一份代码
- **易于维护**: 修改一处，所有地方生效
- **降低错误**: 避免不同地方功能不一致

##### 3.2.2.9 主模块 (main.js)

**职责**: 应用初始化和模块协调

**包含内容**:
- DOM加载完成后的初始化逻辑
- 事件监听器绑定
- 模块间协调和全局状态管理
- **项目初始化配置流程管理**

**新增功能**:
- 检测是否已配置飞书
- 引导用户完成飞书配置
- 触发数据同步流程

### 3.3 CSS模块划分

前端CSS样式按照功能和样式类型划分为以下模块：

1. **基础样式模块** (`base.css`) - 全局基础样式和动画
2. **用户区域模块** (`user-section.css`) - 用户信息区域样式
3. **布局模块** (`layout.css`) - 页面布局和板块样式
4. **活动按钮模块** (`activity-buttons.css`) - 活动按钮样式
5. **活动颜色模块** (`activity-colors.css`) - 活动分类颜色定义
6. **计时器模块** (`timer.css`) - 计时器区域样式
7. **控制按钮模块** (`control-buttons.css`) - 控制按钮样式
8. **详情模态框模块** (`detail-modal.css`) - 记录详情浮窗样式
9. **详情表单模块** (`detail-form.css`) - 记录详情表单样式
10. **导航模块** (`navigation.css`) - 导航链接样式
11. **记录表格模块** (`records-table.css`) - 记录表格样式
12. **统计模块** (`stats.css`) - 统计信息样式
13. **标签模块** (`labels.css`) - 分类和活动标签样式
14. **类别管理模块** (`manage-categories.css`) - 类别管理页面样式
15. **记录控制模块** (`records-controls.css`) - 记录筛选控制区域样式
16. **分页模块** (`pagination.css`) - 分页控件样式
17. **段落模块** (`segments.css`) - 段落信息样式
18. **记录详情模块** (`record-detail.css`) - 记录详情样式
19. **选中记录模块** (`selected-record.css`) - 选中记录样式
20. **详情分段模块** (`detail-sections.css`) - 详情页分段样式
21. **收获记录模块** (`remark.css`) - 收获记录区域样式
22. **活动类别模块** (`activity-category.css`) - 活动类别选择框样式
23. **开始时间模块** (`start-time.css`) - 开始时间输入框样式
24. **情绪标签模块** (`emotion-tag.css`) - 情绪标签样式
25. **控制按钮模块** (`control-btn.css`) - 控制按钮特殊样式
26. **飞书配置模块** (`feishu-config.css`) - 飞书配置样式
27. **情绪墙模块** (`mood-wall.css`) - 情绪墙样式
28. **情绪象限模块** (`emotion-quadrant.css`) - 情绪象限分组样式

#### 3.3.2 样式优化特点

##### 导航链接样式优化
- 导航链接采用圆角设计和颜色主题区分
- 按钮具有悬停效果和动画过渡
- 响应式设计适配不同屏幕尺寸
- 首页导航按钮定位在右侧，使用绝对定位确保正确显示
- 不同功能按钮具有独特的颜色主题：
  - 查看历史记录：绿色主题
  - 情绪与活动墙：橙色主题
  - 项目说明：紫色主题
  - 管理类别：青色主题

#### 3.3.1 CSS模块依赖关系

CSS模块采用扁平化结构，所有模块都直接依赖于基础样式模块，其他模块之间没有直接依赖关系。

```
graph TD
    A[基础样式 base.css] --> B[用户区域 user-section.css]
    A --> C[布局 layout.css]
    A --> D[活动按钮 activity-buttons.css]
    A --> E[活动颜色 activity-colors.css]
    A --> F[计时器 timer.css]
    A --> G[控制按钮 control-buttons.css]
    A --> H[详情模态框 detail-modal.css]
    A --> I[详情表单 detail-form.css]
    A --> J[导航 navigation.css]
    A --> K[记录表格 records-table.css]
    A --> L[统计 stats.css]
    A --> M[标签 labels.css]
    A --> N[类别管理 manage-categories.css]
    A --> O[记录控制 records-controls.css]
    A --> P[分页 pagination.css]
    A --> Q[段落 segments.css]
    A --> R[记录详情 record-detail.css]
    A --> S[选中记录 selected-record.css]
    A --> T[详情分段 detail-sections.css]
    A --> U[收获记录 remark.css]
    A --> V[活动类别 activity-category.css]
    A --> W[开始时间 start-time.css]
    A --> X[情绪标签 emotion-tag.css]
    A --> Y[控制按钮 control-btn.css]
    A --> Z[飞书配置 feishu-config.css]
    A --> AA[情绪墙 mood-wall.css]
    A --> AB[情绪象限 emotion-quadrant.css]
```

## 4. 功能模块设计

### 4.1 时间记录模块

#### 4.1.1 功能描述
实现时间记录的核心功能，包括活动选择、计时控制、记录保存等。

#### 4.1.2 核心逻辑
1. 用户选择活动类别和具体活动
2. 点击【开始】按钮启动计时器
3. 计时过程中实时更新显示时间
4. 点击【停止】按钮结束计时并保存记录
5. 支持暂停和继续功能
6. 支持段落记录，可记录多个专注时间段

#### 4.1.3 数据结构
```json
{
  "id": "记录唯一标识符(UUID格式)",
  "username": "用户名(用户标识)",
  "date": "记录日期（北京时间，格式：YYYY/MM/DD）",
  "activity": "活动名称(用户输入的活动描述)",
  "activityCategory": "活动类别(根据活动名称匹配的类别)",
  "startTime": "开始时间（UTC时间格式，ISO 8601标准）",
  "endTime": "结束时间（UTC时间格式，ISO 8601标准）",
  "duration": "计时时长（毫秒，所有段落累计时间）",
  "timeSpan": "时间跨度（毫秒，从开始到结束的总时间）",
  "pauseCount": "暂停次数(段落数量)",
  "remark": "备注信息(用户输入的收获或感想)",
  "emotion": "情绪标签(用户选择的情绪类型)",
  "segments": [
    {
      "start": "段落开始时间（UTC时间格式，ISO 8601标准）",
      "end": "段落结束时间（UTC时间格式，ISO 8601标准）",
      "duration": "段落持续时间（毫秒，可选字段）"
    }
  ]
}
```

#### 4.1.4 跨页面数据刷新机制
**功能描述**：确保在任一页面修改数据后，其他相关页面能实时刷新显示最新数据

**核心逻辑**：
1. 当用户在活动详情页保存或删除记录后，自动触发当前页面及其他相关页面的数据刷新
2. 使用localStorage实现跨页面通信，通过发送刷新信号通知其他页面更新数据
3. 各页面监听存储事件，接收到刷新信号后重新加载对应数据

**数据流逻辑**：
```
用户操作(保存/删除记录)
    ↓
触发当前页面数据刷新
    ↓
发送刷新信号到localStorage
    ↓
其他页面监听到信号
    ↓
重新加载页面数据
```

**关键实现**：
1. **信号发送**：在记录详情保存或删除操作完成后，通过localStorage.setItem发送包含时间戳和源页面信息的刷新信号
2. **信号接收**：各页面通过window.addEventListener('storage')监听localStorage变化，接收到刷新信号后重新加载数据
3. **避免重复刷新**：通过检查信号中的源页面信息，避免页面刷新自己

**优势**：
- 数据一致性：确保所有页面显示的数据保持同步
- 用户体验：无需手动刷新页面即可看到最新数据
- 实时性：数据修改后立即在所有相关页面反映

### 4.2 情绪墙与活动类型墙模块

#### 4.2.1 功能描述
提供情绪和活动类型的可视化展示，帮助用户了解自己的时间分配和情绪变化。

#### 4.2.2 核心逻辑
1. 按日期展示情绪和活动类型数据
2. 使用颜色方块表示不同类型的情绪和活动
3. 支持点击方块查看详细记录
4. 提供关键词词云展示

#### 4.2.3 数据结构
```json
{
  "moodData": [
    {
      "name": "情绪名称",
      "color": "颜色值",
      "days": [
        {
          "date": "日期",
          "count": "出现次数",
          "record_ids": ["记录ID列表"],
          "activities": ["活动名称列表"],
          "durations": ["时长列表"]
        }
      ]
    }
  ],
  "activityData": [
    {
      "name": "活动类别",
      "color": "颜色值",
      "days": [
        {
          "date": "日期",
          "count": "出现次数",
          "duration": "总时长",
          "record_ids": ["记录ID列表"],
          "activity_categories": ["活动类别列表"],
          "activities": ["活动名称列表"]
        }
      ]
    }
  ]
}
```

#### 4.2.4 情绪分类设计
情绪按照四个象限进行分类：

1. **正向+专注**：惊奇、兴奋、高兴、愉悦
2. **正向+松弛**：安逸、安心、满足、宁静、放松
3. **负面+松弛**：悲伤、伤心、沮丧、疲惫
4. **负面+专注**：惊恐、紧张、愤怒、苦恼

每种情绪都有对应的十六进制颜色值，确保在整个应用中保持一致性。

#### 4.2.5 情绪选择交互优化
为了提升用户体验，情绪多选功能进行了以下优化：

1. **视觉反馈增强**：
   - 选中状态有明显的视觉变化（边框、阴影、亮度调整）
   - 添加了选中和取消选中的动画效果
   - 悬停时有光泽扫过效果

2. **交互体验优化**：
   - 确保最小触摸目标为44px，符合移动端标准
   - 添加触觉反馈（震动效果）增强操作感知
   - 防止文本选择干扰点击操作

3. **响应式设计**：
   - 在不同屏幕尺寸下都能良好显示
   - 移动端和桌面端体验一致

4. **选中标识优化**：
   - 在情绪按钮右上角添加√标识，提供明确的视觉反馈
   - 选中时√标识通过动画出现，取消选中时√标识消失
   - √标识使用绿色背景和白色符号，符合用户认知习惯

5. **点击操作优化**：
   - 使用事件委托方式绑定点击事件，提高稳定性和性能
   - 添加防重复点击机制，避免快速点击导致的问题
   - 保持原有的视觉反馈和触觉反馈效果

#### 4.2.6 情绪墙和活动墙（v1.2.1）
实现情绪墙和活动墙的可视化展示功能，帮助用户了解情绪与活动的关系。

**核心逻辑**:
1. 后端API获取最近7天的情绪和活动数据
2. 按日期组织数据，最近日期在上
3. 前端渲染情绪墙和活动类型墙，每个方块包含对应的记录ID、活动类别、活动名称和时长信息
4. 情绪墙展示的文字显示为具体的情绪名称
5. **活动墙展示的文字显示为具体的活动类别（直接使用记录中的activityCategory字段值，而不是通过活动名称匹配）**
6. 用户点击方块时，前端直接使用记录ID请求记录详情
7. 后端返回记录详情数据
8. 前端使用统一的记录详情组件显示记录详情，并将模态框标题设置为活动名称

#### 4.2.7 情绪墙和活动墙优化（v1.2.2）
根据用户反馈，对情绪墙和活动墙进行了以下优化：

1. **日期排序优化**：
   - 近一周的日期从近到远从上至下排列
   - 最近的日期显示在最上方

2. **方块显示优化**：
   - 每个活动记录都有一个小方块显示
   - 方块大小为25x25px
   - 根据时长设置透明度，时长越短透明度越高

3. **交互优化**：
   - 鼠标移动到小方块上方时显示活动名称和对应的时长
   - 点击小方块可以打开活动详情的浮窗

4. **视觉优化**：
   - 优化方块的视觉效果，使其更加美观
   - 添加悬停效果和动画过渡

### 4.3 今日计划模块

#### 4.3.1 功能描述
提供今日计划功能，帮助用户规划和回顾每一天。

#### 4.3.2 核心逻辑
1. 用户输入计划内容（重要事项、尝试事项、其他事项等）
2. 系统自动收集当天的活动、情绪和活动类型
3. 支持折叠/展开，折叠时显示简要视图
4. 自动保存（1小时间隔）和手动保存
5. 支持同步到飞书多维表格

#### 4.3.3 数据结构
``json
{
  "id": "计划唯一标识符(UUID格式)",
  "date": "计划日期（格式：YYYY-MM-DD）",
  "importantThings": ["重要事项数1", "重要事项数2", "重要事项数3"],
  "tryThings": ["尝试事项数1", "尝试事项数2", "尝试事项数3"],
  "otherMatters": "其他事项",
  "reading": "今日充电（要阅读）",
  "score": "今日评分（优秀/良好/一般/较差/很差）",
  "scoreReason": "评分原因",
  "activities": [
    {
      "activity": "活动名称",
      "category": "活动类别",
      "duration": "时长（毫秒）",
      "startTime": "开始时间（UTC时间）"
    }
  ],
  "emotions": ["情绪集合"],
  "activityCategories": ["活动类型集合"],
  "totalDuration": "总专注时长（毫秒）",
  "creationDuration": "创作时长（毫秒）",
  "createdAt": "创建时间（UTC时间）",
  "updatedAt": "更新时间（UTC时间）",
  "syncedToFeishu": "是否同步到飞书",
  "lastFeishuSyncAt": "最后同步时间（UTC时间）",
  "feishuRecordId": "飞书多维表格记录ID（可选）"
}
```

#### 4.3.4 核心功能说明

##### 4.3.4.1 自动更新统计数据
**后端API**: `DailyPlanUtils.update_plan_from_records()`

**数据流逻辑**:
```
加载用户选择日期记录 --> 遍历记录 --> 收集活动/情绪/类型 --> 计算时长 --> 更新计划
```

**关键逻辑**:
1. 根据用户选择的日期加载对应的所有活动记录
2. 收集活动信息（名称、类别、时长）
3. 使用Set收集并去重情绪和活动类型
4. 累计总时长和创作时长
5. 更新计划对象

```python
def update_plan_from_records(plan):
    # 加载指定日期记录
    today_records = [r for r in all_records if r.get('date') == date_str]
    
    # 初始化收集器
    activities = []
    emotions = set()
    activity_categories = set()
    total_duration = 0
    creation_duration = 0
    
    for record in today_records:
        # 收集活动
        activities.append({
            'activity': record.get('activity'),
            'category': record.get('activityCategory'),
            'duration': record.get('duration'),
            'startTime': record.get('startTime')
        })
        
        # 收集情绪
        emotion_str = record.get('emotion', '')
        if emotion_str:
            for emotion in emotion_str.split(', '):
                emotions.add(emotion.strip())
        
        # 收集活动类型
        category = record.get('activityCategory', '')
        if category:
            activity_categories.add(category)
        
        # 累计时长
        duration = record.get('duration', 0)
        total_duration += duration
        if is_creation_activity(record):
            creation_duration += duration
    
    # 更新计划
    plan['activities'] = activities
    plan['emotions'] = list(emotions)
    plan['activityCategories'] = list(activity_categories)
    plan['totalDuration'] = total_duration
    plan['creationDuration'] = creation_duration
    
    return plan
```

##### 4.3.4.2 日期选择功能
**前端API**: `DailyPlanModule.selectDate()`

**数据流逻辑**:
```
用户选择日期 --> 调用API加载指定日期计划 --> 更新页面显示
```

**关键逻辑**:
1. 提供日期选择器供用户选择日期
2. 根据选择的日期加载对应的计划
3. 更新页面显示内容
4. 支持前后日期切换

##### 4.3.4.3 自动保存机制
**前端API**: `DailyPlanModule.startAutoSave()`

**数据流逻辑**:
```
初始化模块 --> 启动定时器 --> 每1小时执行 --> 收集表单数据 --> 调用API保存 --> 检查飞书配置 --> 如已配置则同步
```

**触发保存的时机**:
1. 自动保存：1小时间隔（**自动保存时间更新为北京时间整点，如10:00、11:00等**）
2. 输入框失焦：失去焦点时保存
3. 收起计划时：点击收起按钮时保存并同步

**注意事项**:
- 自动保存和同步功能应针对当前编辑的日期，而不是强制切换到当前日期
- 当用户编辑历史日期计划时，系统应保持在该日期界面，不应自动跳转到当前日期
- **自动保存时间更新为北京时间整点，确保时间显示的一致性和可预测性**

##### 4.3.4.4 飞书同步功能
**后端API**: `/api/daily-plan/sync-feishu`

**数据流逻辑**:
```
获取飞书字段信息 --> 建立字段映射 --> 加载计划 --> 格式化数据 --> 使用映射字段名构建记录 --> 【新增】查询是否已存在记录 --> 存在则更新/不存在则创建 --> 更新同步状态
```

**关键逻辑**:
1. 调用飞书API获取表格字段列表
2. 根据关键词匹配建立字段映射
3. 加载今日计划数据
4. 格式化日期和时长字段
5. 使用映射后的完整字段名构建飞书记录
6. **【v1.2.4新增】查询飞书表格中是否已存在当天日期的记录**
   - 如果存在：调用更新API (PUT)
   - 如果不存在：调用创建API (POST)
7. 更新本地同步状态
8. 返回相应消息（告知用户是更新还是创建）

**字段映射规则**（v1.2.5优化）:
| 内部字段名 | 匹配关键词 | 示例字段名 |
|-----------|----------|-----------|
| date | 今天是/日期/date | 今天是——、计划日期、Date |
| importantThings | 重要/important | 重要的三件事、今日重点 |
| tryThings | 尝试/try | 要尝试的三件事、今日尝试 |
| otherMatters | 其他/other | 其他事项、其他待办 |
| reading | 充电/阅读/reading | 今日充电、阅读学习 |
| score | 打分/评分（非原因） | 给今天打个分、今日评分 |
| scoreReason | 为什么/原因/reason | 为什么？、评分原因 |
| activities | 活动+(明细/事项) | 今日活动事项、活动明细 |
| emotions | 情绪/emotion | 今日情绪汇总、情绪记录 |
| totalDuration | 专注+总 | 专注时长、总时长 |
| creationDuration | 创作/creation | 创作时长、创作专注 |

**数据转换**:
- 日期转为时间戳（毫秒）
- 时长格式化为中文（X小时X分钟X秒）
- 活动列表转为文本格式
- 情绪集合保持数组格式

##### 4.3.4.5 计划文件管理
**后端API**: `DailyPlanUtils`

**数据流逻辑**:
```
创建/更新计划 --> 保存到计划索引文件
```

**关键逻辑**:
1. 所有计划数据统一保存在`plans.json`索引文件中
2. 每次请求都返回当日计划，如果不存在则自动创建
3. 索引文件包含所有计划的完整数据，包括ID、日期、创建/更新时间、飞书记录ID以及所有计划内容

**索引文件结构**:
```json
{
  "计划ID1": {
    "id": "计划ID1",
    "date": "2025-10-18",
    "importantThings": ["重要事项1", "重要事项2", "重要事项3"],
    "tryThings": ["尝试事项1", "尝试事项2", "尝试事项3"],
    "otherMatters": "其他事项",
    "reading": "今日充电",
    "score": "良好",
    "scoreReason": "原因说明",
    "activities": [],
    "emotions": [],
    "activityCategories": [],
    "totalDuration": 0,
    "creationDuration": 0,
    "createdAt": "2025-10-18T06:12:05.182191Z",
    "updatedAt": "2025-10-18T16:06:40.335447Z",
    "syncedToFeishu": false,
    "lastFeishuSyncAt": null,
    "feishuRecordId": null
  },
  "计划ID2": {
    "id": "计划ID2",
    "date": "2025-10-19",
    "importantThings": ["重要事项1", "重要事项2", "重要事项3"],
    "tryThings": ["尝试事项1", "尝试事项2", "尝试事项3"],
    "otherMatters": "其他事项",
    "reading": "今日充电",
    "score": "良好",
    "scoreReason": "原因说明",
    "activities": [],
    "emotions": [],
    "activityCategories": [],
    "totalDuration": 0,
    "creationDuration": 0,
    "createdAt": "2025-10-19T00:00:00.000000Z",
    "updatedAt": "2025-10-19T12:00:00.000000Z",
    "syncedToFeishu": false,
    "lastFeishuSyncAt": null,
    "feishuRecordId": null
  }
}
```

#### 4.3.5 数据存储
**文件路径**: `data/daily_plans/plans.json`

**文件结构**:
- 所有计划数据统一存储在一个JSON文件中
- 使用计划ID作为键，便于快速查找
- UTF-8编码，支持中文
- 缩进格式，便于阅读

### 4.4 数据导入导出模块

#### 4.3.1 功能描述
支持用户导入和导出时间记录数据，便于数据迁移和备份。

#### 4.3.2 核心逻辑
1. 支持JSON格式的数据导入
2. 提供数据导出功能
3. 实现数据验证和错误处理
4. 支持多用户数据管理
5. **【v1.2.6新增】导出到飞书时避免重复记录**

#### 4.3.3 飞书导出优化（v1.2.6）

**问题**：导出记录到飞书时直接创建新记录，导致重复记录产生。

**解决方案**：采用"存在则更新，不存在则创建"的策略：

```
格式化记录数据
   ↓
【第一步】查询所有记录是否已存在
   ↓
   ├─ 记录有ID → 查询飞书表格
   │         ↓
   │    存在 → 添加到更新列表
   │    不存在 → 添加到创建列表
   │
   └─ 记录无ID → 直接添加到创建列表
   ↓
【第二步】批量创建新记录 (batch_create)
   ↓
【第三步】逐条更新已存在记录 (PUT)
   ↓
返回详细统计（新建X条，更新Y条）
```

**关键逻辑**：
1. 遍历所有待导出的记录
2. 对于每条记录，根据 `id(活动唯一标识)` 查询飞书表格
3. 如果存在：添加到更新列表（包含record_id和fields）
4. 如果不存在：添加到创建列表
5. 批量创建新记录（每批最多100条）
6. 逐条更新已存在的记录
7. 返回详细的操作结果（告知用户新建和更新的数量）

**优势**：
- 避免重复记录：同一记录多次导出不会产生重复数据
- 数据完整性：确保每个ID只对应一条记录
- 用户体验：明确告知用户创建和更新的数量
- 向后兼容：不影响原有创建逻辑，首次导出仍正常工作

## 4. 飞书集成模块

### 4.1 功能概述
飞书集成模块负责与飞书多维表格进行数据同步，包括记录导出和计划同步功能。

### 4.2 核心逻辑
飞书集成采用"存在则更新，不存在则创建"的策略，避免重复数据产生。

### 4.3 数据流逻辑

#### 4.3.1 飞书配置加载与保存 (v1.2.17)
**问题**：同步今日计划到飞书时报错"飞书配置错误: App ID或App Secret不正确，请检查配置"。用户已经通过【飞书配置】按钮保存了正确的配置，但同步功能仍然使用测试用的配置。

**原因**：配置保存后，FeishuBitableAPI实例没有重新加载配置，导致仍然使用旧的配置。

**解决方案**：在update_feishu_config函数中添加配置重新加载逻辑，确保新配置生效。

**数据流逻辑**：
```
用户通过前端保存飞书配置
    ↓
POST /api/feishu/config
    ↓
更新配置文件(config/feishu_config.json)
    ↓
重新加载FeishuBitableAPI实例配置
    ↓
后续飞书API调用使用更新后的配置
```

**关键逻辑**：
1. 用户通过前端界面保存飞书配置
2. 后端API更新配置文件
3. 重新加载FeishuBitableAPI实例配置，确保新配置生效
4. 后续飞书同步功能使用正确的配置

**优势**：
- 配置一致性：确保飞书API使用用户保存的最新配置
- 实时生效：配置保存后立即生效，无需重启应用
- 用户体验：解决配置不一致导致的同步失败问题

#### 4.3.2 飞书配置错误处理优化 (v1.2.18)
**问题**：飞书配置错误时提示信息不够明确，用户难以排查问题。

**解决方案**：增强错误处理逻辑，针对不同错误类型提供具体的解决建议。

**错误类型及处理**：
1. **App ID不存在**：提示用户检查飞书应用是否正确创建
2. **参数无效**：提示用户检查App ID和App Secret是否正确
3. **其他错误**：显示具体的错误信息

**优势**：
- 错误信息更加明确
- 便于用户快速定位和解决问题
- 提升用户体验

#### 4.3.3 飞书应用类型支持 (v1.2.19)
**问题**：飞书应用类型支持不够完善，可能影响不同类型应用的认证。

**解决方案**：增强FeishuBitableAPI类以支持不同的应用类型。

**应用类型支持**：
1. **internal类型**：使用`/tenant_access_token/internal`端点
2. **其他类型**：使用`/tenant_access_token`端点

**配置文件结构**：
```json
{
  "app_id": "应用ID",
  "app_secret": "应用密钥",
  "app_type": "应用类型(internal或其他)",
  "tenant_access_token": "访问令牌"
}
```

**优势**：
- 支持更多类型的飞书应用
- 提高飞书集成的兼容性
- 增强系统稳定性

#### 4.3.4 今日计划自动保存时同步计时记录 (v1.2.20)
**问题**：【今日计划已自动保存】功能只同步今日计划数据到飞书，未同步计时记录数据。

**解决方案**：在今日计划自动保存时，同时将今日计划数据和计时记录数据导出到飞书多维表格。

**数据流逻辑**：
```
今日计划自动保存触发
    ↓
保存今日计划数据到本地
    ↓
检查飞书配置是否已设置
    ↓
是 → 静默同步今日计划到飞书
    ↓
获取今日计时记录数据
    ↓
导出计时记录到飞书多维表格
    ↓
更新同步状态显示
```

**关键逻辑**：
1. 今日计划自动保存时触发同步流程
2. 先同步今日计划数据到飞书（使用现有逻辑）
3. 再获取今日的计时记录数据
4. 将计时记录数据导出到飞书多维表格
5. 使用"存在则更新，不存在则创建"策略避免重复记录
6. 更新页面同步状态显示

**优势**：
- 数据完整性：确保今日计划和计时记录数据都同步到飞书
- 用户体验：无需用户手动操作，自动完成数据同步
- 一致性：保证飞书多维表格中的数据与本地数据一致

### 4.4 项目初始化数据同步 (v1.2.21)
**新增功能**：在项目首次启动时，要求用户必须配置飞书集成，并从飞书多维表格同步活动记录和今日计划数据

**数据流逻辑**：
```
应用启动
    ↓
检测飞书配置是否存在
    ↓
是 → 正常启动应用
    ↓
否 → 显示初始化配置界面
    ↓
引导用户完成飞书配置
    ↓
保存飞书配置
    ↓
从飞书多维表格同步所有活动记录
    ↓
从飞书多维表格同步所有今日计划数据
    ↓
数据同步完成
    ↓
应用正常启动
```

**关键逻辑**：
1. **配置检测**：应用启动时检测config/feishu_config.json是否存在且包含有效的app_id和app_secret
2. **配置引导**：如果配置不存在或无效，显示初始化配置界面，引导用户完成飞书配置
3. **数据同步**：
   - 调用FeishuBitableAPI.get_records_from_bitable()获取飞书多维表格中的所有活动记录
   - 将获取的记录转换为本地数据格式并保存到data/records.json
   - 调用FeishuBitableAPI获取飞书多维表格中的所有今日计划数据
   - 将获取的计划数据转换为本地数据格式并保存到data/daily_plans/plans.json
4. **应用启动**：数据同步完成后，应用正常启动并显示同步的数据

**优势**：
- **无缝迁移**：用户可以从飞书多维表格无缝迁移到本地应用
- **数据完整性**：确保所有历史数据都能正确同步到本地
- **用户体验**：提供清晰的初始化流程，降低用户使用门槛

## 5. 飞书配置功能

### 5.1 功能概述
为了方便用户配置飞书应用，系统在主页和历史记录页面都提供了飞书配置入口。用户可以直接在界面上配置飞书应用的App ID和App Secret，无需编辑配置文件。

### 5.2 主页飞书配置（v1.2.9）

#### 5.2.1 功能位置
- **位置**：主页顶部导航区域，与"查看历史记录"、"情绪与活动墙"等链接并列
- **按钮样式**：圆角按钮，蓝绿渐变背景，与导航链接风格一致

#### 5.2.2 核心功能
1. **显示飞书配置模态框**
   - 点击【飞书配置】按钮
   - 调用`window.showFeishuConfig()`函数
   - 通过GET请求获取当前配置：`/api/feishu/config`
   - 在模态框中显示当前的App ID（App Secret不返回）

2. **保存飞书配置**
   - 用户填写App ID和App Secret
   - 点击保存按钮
   - 调用`window.saveFeishuConfig()`函数
   - 验证App ID是否为空
   - 构造更新数据（仅包含填写的字段）
   - 通过POST请求保存配置：`/api/feishu/config`
   - 保存成功后关闭模态框

3. **关闭模态框**
   - 点击关闭按钮
   - 点击模态框外部区域
   - 调用`window.closeFeishuConfig()`函数

#### 5.2.3 数据流逻辑

**显示配置流程**：
```
用户点击飞书配置按钮
    ↓
调用 window.showFeishuConfig()
    ↓
GET /api/feishu/config
    ↓
填充 App ID 到输入框
    ↓
显示飞书配置模态框
```

**保存配置流程**：
```
用户填写 App ID 和 App Secret
    ↓
点击保存按钮
    ↓
调用 window.saveFeishuConfig()
    ↓
验证 App ID 是否为空
    ↓
构造更新数据（只包含填写的字段）
    ↓
POST /api/feishu/config
    ↓
保存成功，显示提示
    ↓
关闭模态框
```

#### 5.2.4 实现细节

**文件修改**：
1. `templates/index.html`
   - 引入`feishu-config.css`样式文件
   - 在`top-navigation`中添加飞书配置按钮
   - 添加飞书配置模态框HTML结构

2. `static/js/script.js`
   - 实现`window.showFeishuConfig()`函数
   - 实现`window.closeFeishuConfig()`函数
   - 实现`window.saveFeishuConfig()`函数
   - 添加模态框点击外部关闭事件

3. `static/css/modules/user-section.css`
   - 添加`.top-navigation .feishu-config-btn`样式
   - 渐变背景色（#0066ff到#00b900）
   - 悬停和点击效果

**安全性考虑**：
- 获取配置时不返回App Secret
- 只有用户输入新的Secret时才更新
- 使用密码类型输入框保护Secret输入

**用户体验优化**：
- 按钮位置醒目，易于访问
- 模态框样式与应用整体风格一致
- 保存成功后自动关闭模态框
- 点击模态框外部可关闭（避免误操作）

### 5.3 历史记录页飞书配置
历史记录页面同样提供飞书配置功能，实现逻辑与主页基本一致，确保用户在任何页面都能方便地配置飞书应用。