# 时间记录器项目架构设计文档

## 1. 项目概述

时间记录器是一个基于Python Flask的时间追踪Web应用，帮助用户记录和管理日常活动时间。该应用采用模块化设计，将前端JavaScript代码拆分为多个独立的模块，以提高代码的可维护性和可扩展性。

## 2. 技术架构

### 2.1 后端架构
- **框架**: Python Flask
- **数据存储**: JSON文件存储（无需数据库）
- **API设计**: RESTful API
- **部署**: 独立运行，无需外部依赖

### 2.2 前端架构
- **HTML5**: 语义化标签和现代特性
- **CSS3**: 响应式设计和现代化样式
- **JavaScript**: 原生ES6模块化开发
- **AJAX**: 异步数据交互

### 2.3 时间处理架构
- **时间存储**: 使用UTC时间格式存储所有时间数据
- **时间显示**: 在前端界面显示时转换为北京时间
- **日期记录**: date字段记录北京时间的日期

## 3. 前端架构

### 3.1 模块划分

#### 3.1.1 核心模块
- **主应用模块** (`app.js`) - 应用入口点，负责初始化和模块协调
- **配置模块** (`config.js`) - 全局配置和常量定义，包括活动类别映射、颜色映射等
- **工具模块** (`utils.js`) - 通用工具函数，如时间格式化、类别获取等
- **API模块** (`api.js`) - 封装所有后端API调用
- **UI模块** (`ui.js`) - 负责DOM操作和界面更新
- **计时器模块** (`timer.js`) - 实现计时器核心功能
- **记录详情模块** (`recordDetail.js`) - 处理记录详情相关功能
- **今日计划模块** (`dailyPlan.js`) - 实现今日计划功能
- **飞书配置模块** (`feishuConfig.js`) - 处理飞书集成配置

#### 3.1.2 样式模块
- **基础样式** (`base.css`) - 全局基础样式和重置
- **字节风设计系统** (`byte-design-system.css`) - 字节风设计规范实现
- **活动颜色样式** (`activity-colors.css`) - 活动分类颜色定义，采用统一的颜色管理体系
- **活动按钮样式** (`activity-buttons.css`) - 活动按钮样式定义
- **控制按钮样式** (`control-buttons.css`) - 控制按钮样式定义
- **详情表单样式** (`detail-form.css`) - 记录详情表单样式
- **详情模态框样式** (`detail-modal.css`) - 记录详情模态框样式
- **情绪标签样式** (`emotion-tag.css`) - 情绪标签样式定义
- **标签样式** (`labels.css`) - 活动标签样式定义
- **布局样式** (`layout.css`) - 页面布局样式定义
- **导航样式** (`navigation.css`) - 导航栏样式定义
- **结论样式** (`conclusion.css`) - 结论区域样式定义
- **分页样式** (`pagination.css`) - 分页组件样式定义
- **心情墙样式** (`mood-wall.css`) - 心情墙组件样式定义
- **活动分类样式** (`activity-category.css`) - 活动分类管理样式定义
- **每日计划样式** (`daily-plan.css`) - 今日计划样式定义
- **飞书配置样式** (`feishu-config.css`) - 飞书配置样式定义
- **飞书导入样式** (`feishu-import.css`) - 飞书导入功能样式定义
- **活动选择优化样式** (`activity-selection-optimized.css`) - 活动选择弹窗优化样式定义
- **活动选择按钮样式** (`activity-selection-buttons.css`) - 活动选择弹窗按钮样式定义
- **导航优化样式** (`navigation-optimized.css`) - 导航栏优化样式定义
- **每日计划原始样式** (`daily-plan-original.css`) - 今日计划原始样式定义
- **详情区域样式** (`detail-sections.css`) - 详情区域样式定义
- **活动管理分类样式** (`manage-categories.css`) - 活动分类管理页面样式定义

### 3.2 颜色管理体系
系统采用统一的颜色管理体系，确保所有界面元素的颜色一致性：

1. **颜色定义集中化**：所有活动分类颜色定义集中存储在[data/activity_categories.json](file:///Users/amy/Documents/codes/time_recoder/data/activity_categories.json)文件中
2. **前端映射统一化**：通过[static/js/modules/config.js](file:///Users/amy/Documents/codes/time_recoder/static/js/modules/config.js)中的[colorClassMap](file:///Users/amy/Documents/codes/time_recoder/static/js/modules/config.js#L59-L66)对象实现颜色值到CSS类名的统一映射
3. **CSS样式模块化**：通过[static/css/modules/activity-colors.css](file:///Users/amy/Documents/codes/time_recoder/static/css/modules/activity-colors.css)文件定义所有活动分类的CSS样式
4. **颜色使用规范化**：所有模块通过导入配置和CSS类名使用颜色，避免硬编码和重复定义

这种设计确保了颜色定义的一致性和可维护性，任何颜色调整只需修改配置文件和CSS文件即可全局生效。

## 4. 数据流逻辑

### 4.1 核心数据流

#### 4.1.1 活动记录数据流
```
用户选择活动
    ↓
创建活动记录
    ↓
开始计时
    ↓
暂停/继续操作创建段落
    ↓
停止计时
    ↓
保存记录到本地JSON文件
    ↓
可选：同步当前记录到飞书多维表格（在保存活动详情或停止计时时单独同步）
```

#### 4.1.2 今日计划数据流
```
用户填写今日计划
    ↓
自动保存到本地JSON文件（每小时）
    ↓
可选：同步到飞书多维表格
    ↓
次日自动加载新日期的计划
```

#### 4.1.3 飞书数据同步数据流
```
用户配置飞书集成
    ↓
验证飞书链接有效性
    ↓
从飞书导入数据（活动记录和今日计划）
    ↓
保存到本地JSON文件
    ↓
应用正常启动并显示同步数据
```

#### 4.1.4 飞书数据导入数据流（v1.2.13优化）
```
用户点击【从飞书导入】按钮
    ↓
调用 [/api/feishu/sync-records](file:///Users/amy/Documents/codes/time_recoder/app.py#L2253-L2286) 接口同步活动记录
    ↓
调用 [/api/feishu/sync-plans](file:///Users/amy/Documents/codes/time_recoder/app.py#L1514-L1582) 接口同步今日计划
    ↓
保存到本地JSON文件（records.json和plans.json）
    ↓
刷新页面显示导入的数据
```

### 4.2 数据结构

#### 4.2.1 活动记录结构
```json
{
  "id": "记录唯一标识符",
  "date": "记录日期 (YYYY/MM/DD)",
  "activity": "活动名称",
  "activityCategory": "活动类别",
  "startTime": "开始时间 (ISO 8601格式)",
  "endTime": "结束时间 (ISO 8601格式)",
  "duration": "专注时长 (毫秒)",
  "timeSpan": "时间跨度 (毫秒)",
  "pauseCount": "暂停次数",
  "remark": "备注信息",
  "emotion": "情绪记录 (逗号分隔的字符串)",
  "segments": [
    {
      "start": "段落开始时间 (ISO 8601格式)",
      "end": "段落结束时间 (ISO 8601格式)"
    }
  ]
}
```

#### 4.2.2 今日计划结构
``json
{
  "date": "计划日期 (YYYY-MM-DD)",
  "importantThings": ["重要事项1", "重要事项2", "重要事项3"],
  "tryThings": ["尝试事项1", "尝试事项2", "尝试事项3"],
  "otherMatters": "其他事项",
  "reading": "阅读计划",
  "score": "今日评分",
  "scoreReason": "评分原因",
  "totalDuration": "专注时长",
  "creationDuration": "创作时长",
  "activityCount": "活动次数",
  "activities": ["活动1", "活动2"],
  "emotions": ["情绪1", "情绪2"],
  "activityCategories": ["类别1", "类别2"],
  "lastSyncTime": "最后同步时间",
  "feishuRecordId": "飞书记录ID"
}
```

**飞书字段映射说明**：
- `importantThings` 对应飞书多维表格中的 "今天重要的三件事" 字段
- `tryThings` 对应飞书多维表格中的 "今天要尝试的三件事" 字段
- `score` 对应飞书多维表格中的 "给今天打个分" 字段
- `scoreReason` 对应飞书多维表格中的 "为什么？" 字段

## 5. 飞书集成架构

### 5.1 飞书配置管理
- 通过 `/api/feishu/config` 接口管理飞书配置
- 支持App ID和App Secret的配置和持久化

### 5.2 数据同步机制
- 支持活动记录和今日计划的双向同步
- 自动同步机制（今日计划每小时自动同步），可通过飞书配置页面的【自动同步至飞书】开关控制启用/禁用
- 收起同步机制（点击【收起】按钮时执行同步），不受【自动同步至飞书】开关影响，只要配置了飞书就会同步
- 手动同步机制（通过飞书配置页面触发）
- **支持通过【从飞书导入】按钮一次性同步活动记录和今日计划**
- **同步时准确处理activityCategory字段，确保活动类别信息正确同步**
- **对于飞书多维表格中已存在的记录（通过id字段判断），执行更新操作而不是创建新记录，避免数据重复**
- **优化：移除同步所有记录到飞书的逻辑，改为在每次保存单独活动详情和停止一次活动计时时，单独同步该记录到飞书多维表格**

### 5.3 错误处理
- 网络错误重试机制
- 飞书API错误处理
- 数据格式验证

## 6. 版本更新记录

### v1.2.18 (2025-10-19)
- **功能优化**：
  - 增加飞书导入今日计划日期日志，帮助诊断日期处理问题
  - 增强时区处理逻辑，确保正确转换UTC时间戳到北京时间

### v1.2.17 (2025-10-19)
- **功能优化**：
  - 优化活动选择弹窗按钮颜色显示与活动类别颜色一致
  - 修复飞书配置页面【自动同步至飞书】开关有效性问题

### v1.2.16 (2025-10-19)
- **功能优化**：
  - 优化飞书同步机制，移除同步所有记录到飞书的逻辑
  - 在每次保存单独活动详情和停止一次活动计时时，单独同步该记录到飞书多维表格

### v1.2.15 (2025-10-19)
- **功能修复**：
  - 修复飞书导入今日计划功能，确保能正确同步plans.json文件
  - 完善从飞书多维表格获取今日计划数据并保存到本地的实现
  - 增强错误处理和日志记录

### v1.2.14 (2025-10-19)
- **代码优化**：
  - 合并了 `init_sync_plans_from_feishu` 和 `sync_plans_from_feishu` 函数，避免代码重复
  - 统一了飞书同步今日计划的API端点为 `/api/feishu/sync-plans`
  - 更新了前端调用以使用统一的API端点

### v1.2.13 (2025-10-19)
- **优化功能**：
  - 优化文档描述，明确飞书数据导入包含活动记录和今日计划的同步
  - 优化飞书集成架构描述

### v1.2.12 (2025-10-19)
- **新增功能**：
  - 支持从飞书配置页面手动触发数据导入功能
- **优化功能**：
  - 优化活动选择弹窗布局，每行最多显示8个按钮
  - 优化顶部导航栏样式，统一各页面导航样式
  - 优化计时器区域视觉效果
  - 优化每日计划区域交互体验
- **修复问题**：
  - 修复飞书导入功能未能从指定表格导入所有记录的问题
  - 修复活动详情页情绪按钮显示emoji的问题

### v1.2.11 (2025-10-18)
- **新增功能**：
  - 增加飞书配置模块，统一管理飞书集成配置
  - 增加初始化配置功能，支持首次使用时配置飞书集成
- **优化功能**：
  - 优化记录详情页情绪选择交互
  - 优化移动端适配

### v1.2.10 (2025-10-17)
- **新增功能**：
  - 增加飞书多维表格集成，支持数据同步
  - 增加今日计划自动同步功能
- **优化功能**：
  - 优化情绪墙和活动墙显示效果
  - 优化记录详情页显示效果

### v1.2.9 (2025-10-16)
- **优化功能**：
  - 优化活动选择弹窗布局
  - 优化计时器交互体验
  - 优化移动端适配

### v1.2.8 (2025-10-15)
- **新增功能**：
  - 增加情绪记录功能
  - 增加情绪墙和活动墙可视化展示
- **优化功能**：
  - 优化记录详情页显示效果
  - 优化数据统计功能

### v1.2.7 (2025-10-14)
- **新增功能**：
  - 增加今日计划功能
  - 增加数据统计功能
- **优化功能**：
  - 优化记录管理功能
  - 优化界面交互体验

### v1.2.6 (2025-10-13)
- **新增功能**：
  - 增加活动分类管理功能
  - 增加记录详情编辑功能
- **优化功能**：
  - 优化计时器功能
  - 优化界面显示效果

### v1.2.5 (2025-10-12)
- **初始版本**：
  - 实现基本的时间记录功能
  - 实现活动选择和计时功能
  - 实现记录查看和管理功能