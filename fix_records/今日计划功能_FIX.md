# 新增【今日计划】功能

## 问题描述
用户需要在首页添加【今日计划】功能,方便记录和管理每天的计划,同时自动关联活动数据,并支持同步到飞书多维表格。

## 解决方案

### 1. 数据结构设计
创建了完整的今日计划数据结构,包含:
- 基本信息: 日期、ID、创建/更新时间
- 用户输入字段:
  - 重要的三件事(数组)
  - 要尝试的三件事(数组)
  - 其他事项
  - 今日充电(要阅读)
  - 给今天打分(优秀/良好/一般/较差/很差)
  - 评分原因
- 自动更新字段:
  - 今日活动列表
  - 今日情绪集合
  - 今日专注时长
  - 今日创作专注时长
- 飞书同步状态

### 2. 后端实现

#### 2.1 新增工具类
在 `app.py` 中添加 `DailyPlanUtils` 类:
- `load_daily_plan(date_str)` - 加载指定日期的计划
- `create_new_daily_plan(date_str)` - 创建新计划
- `save_daily_plan(plan)` - 保存计划
- `update_plan_from_records(plan)` - 从活动记录更新统计数据

#### 2.2 新增API接口
- `GET /api/daily-plan` - 获取今日计划
- `POST /api/daily-plan` - 保存今日计划
- `POST /api/daily-plan/sync-feishu` - 同步到飞书

#### 2.3 数据存储
- 计划文件存储在 `data/daily_plans/plan_YYYY-MM-DD.json`
- 每天自动创建新的计划文件
- 自动从活动记录更新统计数据

### 3. 前端实现

#### 3.1 UI设计
在首页顶部添加紫色渐变的今日计划面板:
- 可折叠/展开的设计
- 响应式布局,自适应不同屏幕
- 美观的卡片式分组
- 清晰的视觉层次

#### 3.2 交互功能
- 支持折叠/展开
- 输入框失焦自动保存
- 评分按钮点击选择
- 手动保存按钮
- 同步到飞书按钮
- 实时显示同步状态

#### 3.3 自动更新
- 每次加载/更新记录时自动刷新统计数据
- 活动列表实时更新
- 情绪集合实时更新
- 专注时长实时计算

#### 3.4 自动保存
- 每30秒自动保存一次
- 输入框失焦时自动保存
- 避免数据丢失

### 4. 飞书集成

#### 4.1 数据格式转换
将计划数据转换为飞书多维表格格式:
- 日期字段转为时间戳
- 数组字段转为换行分隔的文本
- 时长字段格式化为可读文本
- 情绪字段保持数组格式

#### 4.2 同步功能
- 手动触发同步
- 记录同步状态和时间
- 显示同步成功/失败状态

### 5. 技术实现细节

#### 5.1 新增文件
- `/static/css/modules/daily-plan.css` - 今日计划样式
- `/static/js/modules/dailyPlan.js` - 今日计划逻辑模块

#### 5.2 修改文件
- `app.py` - 添加后端API和工具类
- `templates/index.html` - 添加UI元素
- `static/js/modules/api.js` - 添加API接口
- `static/js/modules/main.js` - 集成今日计划模块

#### 5.3 核心函数

**后端核心函数**:
```python
DailyPlanUtils.load_daily_plan(date_str)  # 加载计划
DailyPlanUtils.save_daily_plan(plan)  # 保存计划
DailyPlanUtils.update_plan_from_records(plan)  # 更新统计
```

**前端核心函数**:
```javascript
DailyPlanModule.init()  # 初始化
DailyPlanModule.loadTodayPlan()  # 加载今日计划
DailyPlanModule.savePlan()  # 保存计划
DailyPlanModule.syncToFeishu()  # 同步到飞书
DailyPlanModule.refreshStats()  # 刷新统计
DailyPlanModule.startAutoSave()  # 启动自动保存
```

### 6. 数据流逻辑

#### 6.1 初始化流程
```
页面加载 
  → DailyPlanModule.init()
  → 加载今日计划 API
  → 渲染计划数据
  → 启动自动保存定时器
```

#### 6.2 数据更新流程
```
活动记录变化
  → loadRecords()
  → updateStats()
  → DailyPlanModule.refreshStats()
  → 重新加载计划
  → 更新统计数据
  → 重新渲染
```

#### 6.3 保存流程
```
用户编辑
  → 输入框失焦 / 定时器触发
  → 收集表单数据
  → 调用保存API
  → 后端更新统计
  → 返回最新数据
```

#### 6.4 飞书同步流程
```
点击同步按钮
  → 先保存当前数据
  → 调用同步API
  → 后端转换数据格式
  → 调用飞书API
  → 更新同步状态
  → 刷新显示
```

## 用户体验优化

### 1. 视觉设计
- 使用紫色渐变背景,突出计划区域
- 金色强调色标识重要信息
- 清晰的图标和标题
- 半透明的卡片设计
- 优雅的动画过渡

### 2. 交互优化
- 自动保存避免数据丢失
- 即时反馈(选中状态、保存提示)
- 折叠功能节省空间
- 响应式设计适配移动端
- 触觉友好(最小44px点击目标)

### 3. 性能优化
- 定时保存降低服务器压力
- 避免频繁API调用
- 数据缓存减少重复请求
- 异步更新不阻塞UI

## 测试建议

### 功能测试
1. ✅ 创建新的今日计划
2. ✅ 填写各个字段并保存
3. ✅ 验证自动保存功能
4. ✅ 完成活动后检查统计数据更新
5. ✅ 测试同步到飞书功能
6. ✅ 测试折叠/展开功能
7. ✅ 测试响应式布局

### 兼容性测试
1. ✅ 桌面端浏览器测试
2. ✅ 移动端浏览器测试
3. ✅ 不同屏幕尺寸测试

## 注意事项

1. **端口变更**: 为避免冲突,后端运行端口改为 5003
2. **自动保存**: 30秒间隔,避免频繁保存
3. **飞书配置**: 需要先配置飞书App ID和Secret
4. **时区处理**: 统一使用UTC存储,北京时间显示
5. **数据迁移**: 老用户首次使用会自动创建计划

## 后续优化建议

1. **数据分析**: 添加周/月计划完成度分析
2. **提醒功能**: 添加计划提醒和待办提醒
3. **模板功能**: 支持保存和复用计划模板
4. **导出功能**: 支持导出为PDF或Word
5. **协作功能**: 支持团队共享计划
6. **AI助手**: 基于历史数据提供计划建议

## 更新日期
2025-10-18

## 修改人
Amy
